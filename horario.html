<script>
    const _0x8F = "MDEwNTIz"; 
    let SISTEMA_DESBLOQUEADO = false; 

    // ‚ö†Ô∏è HE CORREGIDO ESTO: Ahora todos terminan en 'output=csv' para evitar fallos
    const urls = {
        "Lunes": "https://docs.google.com/spreadsheets/d/e/2PACX-1vTa_AjdQ-TzUs68ciZCnbgsUzqRF78m8e-oMrmbrorAsXjaFckYe6JQAzyKFlY6jcvWTMVZ3UDcqxMx/pub?gid=0&single=true&output=csv",
        "Martes": "https://docs.google.com/spreadsheets/d/e/2PACX-1vTa_AjdQ-TzUs68ciZCnbgsUzqRF78m8e-oMrmbrorAsXjaFckYe6JQAzyKFlY6jcvWTMVZ3UDcqxMx/pub?gid=1905233272&single=true&output=csv",
        "Mi√©rcoles": "https://docs.google.com/spreadsheets/d/e/2PACX-1vTa_AjdQ-TzUs68ciZCnbgsUzqRF78m8e-oMrmbrorAsXjaFckYe6JQAzyKFlY6jcvWTMVZ3UDcqxMx/pub?gid=745373517&single=true&output=csv",
        "Jueves": "https://docs.google.com/spreadsheets/d/e/2PACX-1vTa_AjdQ-TzUs68ciZCnbgsUzqRF78m8e-oMrmbrorAsXjaFckYe6JQAzyKFlY6jcvWTMVZ3UDcqxMx/pub?gid=314818236&single=true&output=csv",
        "Viernes": "https://docs.google.com/spreadsheets/d/e/2PACX-1vTa_AjdQ-TzUs68ciZCnbgsUzqRF78m8e-oMrmbrorAsXjaFckYe6JQAzyKFlY6jcvWTMVZ3UDcqxMx/pub?gid=1396865785&single=true&output=csv"
    };

    let memoriaCache = {}; 

    function leerHoja(url) {
        // Si ya lo le√≠mos en esta sesi√≥n, lo devolvemos r√°pido
        if (memoriaCache[url]) return Promise.resolve(memoriaCache[url]);

        return new Promise(resolve => {
            // A√±adimos un n√∫mero aleatorio al final para obligar a Google a darnos datos nuevos
            const urlFresca = url + "&t=" + Date.now() + Math.random();
            
            Papa.parse(urlFresca, { 
                download: true, 
                header: false, 
                skipEmptyLines: true, 
                complete: res => { 
                    memoriaCache[url] = res.data; 
                    resolve(res.data); 
                }, 
                error: e => {
                    console.error("Error leyendo hoja:", e);
                    resolve([]); 
                }
            });
        });
    }

    // ... (El resto de funciones: timeToMins, formatName, esNombreValido, etc. siguen IGUAL) ...
    // COPIA AQU√ç EL RESTO DEL SCRIPT DE LA RESPUESTA ANTERIOR
    function timeToMins(t) { if(!t) return 0; const [h, m] = t.split(':').map(Number); return h * 60 + m; }
    function minsToTime(m) { const hh = Math.floor(m / 60).toString().padStart(2,'0'); const mm = (m % 60).toString().padStart(2,'0'); return `${hh}:${mm}`; }
    function formatName(n) { return n.toLowerCase().replace(/(?:^|\s)\S/g, function(a) { return a.toUpperCase(); }); }

    function esNombreValido(texto) {
        if (!texto || texto.length < 2) return false;
        const t = texto.toUpperCase().trim();
        const prohibidos = ["HORA", "ALUMNO", "APOYO", "INGL√âS", "INGLES", "CLASE"];
        if (prohibidos.some(p => t.includes(p))) return false;
        if (/^(A|I|IN|ING)\s*\d+$/.test(t)) return false;
        return true;
    }

    function agruparClases(clases) {
        if(clases.length === 0) return [];
        let grupos = [];
        let actual = null;
        clases.forEach(clase => {
            const startMins = timeToMins(clase.h);
            if (actual) {
                if (actual.dia === clase.dia && actual.tipo === clase.tipo && startMins === actual.endMins) {
                    actual.endMins += 30; return;
                } else { grupos.push(actual); }
            }
            actual = { dia: clase.dia, startMins: startMins, endMins: startMins + 30, materia: clase.materia, tipo: clase.tipo };
        });
        if (actual) grupos.push(actual);
        return grupos;
    }

    async function ejecutarBusqueda(nombre) {
        document.getElementById('search-area').style.display = 'none';
        document.getElementById('loading-spinner').style.display = 'block';
        document.getElementById('resultado').innerHTML = '';
        const nombreBuscado = nombre.toLowerCase().trim();
        const dias = Object.keys(urls);
        const promesas = dias.map(dia => leerHoja(urls[dia]));
        const resultados = await Promise.all(promesas);
        
        let clasesRaw = [];

        dias.forEach((dia, idx) => {
            const data = resultados[idx];
            if(!data) return;
            data.forEach(row => {
                if(row[1]) {
                    let h = row[1].trim().substring(0,5);
                    // Apoyo (2-7)
                    for(let c=2; c<=7; c++) {
                        let val = row[c] || "";
                        if(esNombreValido(val) && val.toLowerCase().includes(nombreBuscado)) 
                            clasesRaw.push({dia, h, materia: "Apoyo", tipo: "apoyo"});
                    }
                    // Ingl√©s (9-14)
                    for(let c=9; c<=14; c++) {
                        let val = row[c] || "";
                        if(esNombreValido(val) && val.toLowerCase().includes(nombreBuscado)) 
                            clasesRaw.push({dia, h, materia: "Ingl√©s", tipo: "ingles"});
                    }
                }
            });
        });

        document.getElementById('loading-spinner').style.display = 'none';
        
        if(clasesRaw.length > 0) {
            const clasesAgrupadas = agruparClases(clasesRaw);
            let html = `<h3 style="color:var(--c-primary); margin-bottom:20px; font-family:'Schoolbell', cursive;">
                        Horario de <span style="color:var(--c-accent)">${formatName(nombre)}</span>
                        </h3>`;
            
            clasesAgrupadas.forEach(item => {
                const horarioTexto = `${minsToTime(item.startMins)} - ${minsToTime(item.endMins)}`;
                html += `
                    <div class="result-card type-${item.tipo}">
                        <div class="card-info">
                            <span class="card-day">${item.dia}</span>
                            <div class="card-time-wrapper">
                                <div class="clock-icon"></div>
                                <span class="card-time">${horarioTexto}</span>
                            </div>
                        </div>
                        <span class="badge bg-${item.tipo}">${item.materia}</span>
                    </div>`;
            });
            document.getElementById('resultado').innerHTML = html;
            document.getElementById('actions-panel').style.display = 'block';

            if(SISTEMA_DESBLOQUEADO) {
                document.getElementById('btnCopiar').style.display = 'block';
                document.getElementById('btnDirectorio').style.display = 'block';
                document.getElementById('btnReset').style.display = 'block'; 
            } else {
                document.getElementById('btnCopiar').style.display = 'none';
                document.getElementById('btnDirectorio').style.display = 'none';
                document.getElementById('btnReset').style.display = 'none'; 
            }
        } else {
            document.getElementById('error-msg').innerText = "No hemos encontrado ese nombre.";
            document.getElementById('error-msg').style.display = 'block';
            document.getElementById('search-area').style.display = 'block';
        }
    }

    async function cargarDirectorio() {
        const area = document.getElementById('directory-area');
        area.innerHTML = "Cargando..."; area.style.display = 'block';
        const promesas = Object.values(urls).map(url => leerHoja(url));
        const resultados = await Promise.all(promesas);
        let alumnos = new Set();
        
        resultados.forEach(data => {
            if(!data) return;
            data.forEach(row => {
                [2,3,4,5,6,7,9,10,11,12,13,14].forEach(c => {
                    let txt = (row[c] || "").trim();
                    if(esNombreValido(txt)) {
                        alumnos.add(txt.toLowerCase());
                    }
                });
            });
        });
        
        let html = "";
        Array.from(alumnos).sort().forEach(n => {
            html += `<span class="student-chip" onclick="seleccionarAlumno('${n}')">${n}</span>`;
        });
        area.innerHTML = html;
    }

    window.seleccionarAlumno = n => { document.getElementById('magicInput').value = n; ejecutarBusqueda(n); };

    document.addEventListener('DOMContentLoaded', () => {
        const input = document.getElementById('magicInput');
        const btn = document.getElementById('btnBuscar');
        const btnCopiar = document.getElementById('btnCopiar');

        const login = () => {
            const val = input.value.trim();
            if(!val) return;
            if(!SISTEMA_DESBLOQUEADO && btoa(val) === _0x8F) {
                SISTEMA_DESBLOQUEADO = true;
                document.getElementById('status-indicator').innerText = "üîì MODO ACADEMIA";
                input.value = ""; input.placeholder = "Nombre del alumno...";
                document.getElementById('actions-panel').style.display = 'block';
            } else { 
                ejecutarBusqueda(val); 
            }
        };

        btn.onclick = login;
        input.onkeypress = e => { if(e.key === 'Enter') login(); };
        document.getElementById('btnDirectorio').onclick = cargarDirectorio;
        document.getElementById('btnReset').onclick = () => location.reload();

        btnCopiar.onclick = () => {
            const url = window.location.href.split('?')[0] + "?alumno=" + encodeURIComponent(input.value.trim());
            navigator.clipboard.writeText(url).then(() => { 
                const original = btnCopiar.innerText;
                btnCopiar.innerText = "‚úÖ ENLACE COPIADO";
                setTimeout(() => btnCopiar.innerText = original, 2000);
            });
        };
        
        const p = new URLSearchParams(window.location.search).get('alumno');
        if(p) { input.value = p; ejecutarBusqueda(p); }
    });
</script>
