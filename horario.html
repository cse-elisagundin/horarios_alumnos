<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Horario Alumnos - CSE Elisa Gundín</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Schoolbell&family=Outfit:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        /* Copia aquí todo el bloque <style> de tu horario.html original */
        /* (El CSS que ya tenías es perfecto) */
    </style>
</head>
<body>
<script>
    const URL_MODIFICACIONES = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTa_AjdQ-TzUs68ciZCnbgsUzqRF78m8e-oMrmbrorAsXjaFckYe6JQAzyKFlY6jcvWTMVZ3UDcqxMx/pub?output=csv";
    
    // Todas tus URLs originales
    const URL_EXAMENES = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRrK53aJ-n_g-6-yrsASWYrkCc47WpA3uKQGXvuixv0OZ5BkzbTRJrDI0Sat2qxKRvX7NdOsjlsFrpR/pub?output=csv"; 
    const URL_FALTAS = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTa_AjdQ-TzUs68ciZCnbgsUzqRF78m8e-oMrmbrorAsXjaFckYe6JQAzyKFlY6jcvWTMVZ3UDcqxMx/pub?gid=1356052707&single=true&output=tsv";
    const URL_AVISOS = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTa_AjdQ-TzUs68ciZCnbgsUzqRF78m8e-oMrmbrorAsXjaFckYe6JQAzyKFlY6jcvWTMVZ3UDcqxMx/pub?gid=1694124280&single=true&output=tsv";
    const URL_CALENDARIO = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTa_AjdQ-TzUs68ciZCnbgsUzqRF78m8e-oMrmbrorAsXjaFckYe6JQAzyKFlY6jcvWTMVZ3UDcqxMx/pub?gid=1477113232&single=true&output=tsv";

    const urls = {
        "Lunes": "https://docs.google.com/spreadsheets/d/e/2PACX-1vTa_AjdQ-TzUs68ciZCnbgsUzqRF78m8e-oMrmbrorAsXjaFckYe6JQAzyKFlY6jcvWTMVZ3UDcqxMx/pub?gid=0&single=true&output=tsv",
        "Martes": "https://docs.google.com/spreadsheets/d/e/2PACX-1vTa_AjdQ-TzUs68ciZCnbgsUzqRF78m8e-oMrmbrorAsXjaFckYe6JQAzyKFlY6jcvWTMVZ3UDcqxMx/pub?gid=1905233272&single=true&output=tsv",
        "Miércoles": "https://docs.google.com/spreadsheets/d/e/2PACX-1vTa_AjdQ-TzUs68ciZCnbgsUzqRF78m8e-oMrmbrorAsXjaFckYe6JQAzyKFlY6jcvWTMVZ3UDcqxMx/pub?gid=745373517&single=true&output=tsv",
        "Jueves": "https://docs.google.com/spreadsheets/d/e/2PACX-1vTa_AjdQ-TzUs68ciZCnbgsUzqRF78m8e-oMrmbrorAsXjaFckYe6JQAzyKFlY6jcvWTMVZ3UDcqxMx/pub?gid=314818236&single=true&output=tsv",
        "Viernes": "https://docs.google.com/spreadsheets/d/e/2PACX-1vTa_AjdQ-TzUs68ciZCnbgsUzqRF78m8e-oMrmbrorAsXjaFckYe6JQAzyKFlY6jcvWTMVZ3UDcqxMx/pub?gid=1396865785&single=true&output=tsv"
    };

    function getWeekNumber(d) {
        d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
        var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
        return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
    }

    function leerHoja(url) {
        return new Promise(resolve => {
            let config = { download:true, skipEmptyLines:true };
            if(url.includes("output=tsv")) config.delimiter = "\t";
            Papa.parse(url + "&t=" + Date.now(), { ...config, complete: res => resolve(res.data), error: () => resolve([]) });
        });
    }

    async function ejecutarBusqueda(nombre) {
        document.getElementById('loading-spinner').style.display = 'block';
        document.getElementById('search-area').style.display = 'none';
        const buscado = nombre.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
        const dias = Object.keys(urls);
        
        const [horarios, examenes, faltas, calend, mods] = await Promise.all([
            Promise.all(dias.map(d => leerHoja(urls[d]))),
            leerHoja(URL_EXAMENES), leerHoja(URL_FALTAS), leerHoja(URL_CALENDARIO), leerHoja(URL_MODIFICACIONES)
        ]);

        const isSemanaPar = getWeekNumber(new Date()) % 2 === 0;
        let clasesFinales = [];

        dias.forEach((dia, idx) => {
            let data = JSON.parse(JSON.stringify(horarios[idx]));
            
            // 1. Filtro A/B
            for(let r=1; r<data.length; r++){
                for(let c=1; c<data[r].length; c++){
                    if(c===7) continue;
                    let v = (data[r][c]||"").trim();
                    if((v.includes("[A]") && isSemanaPar) || (v.includes("[B]") && !isSemanaPar)) data[r][c] = "";
                    else data[r][c] = v.replace(/\[A\]|\[B\]/g, "").trim();
                }
            }

            // 2. Aplicar Mods (Inyectamos etiquetas para el frontend de padres)
            if(mods) mods.forEach((m, i) => {
                if(i===0 || (m[0]||"").trim().toLowerCase() !== dia.toLowerCase()) return;
                let start = data.findIndex(row => (row[0]||"") === m[1] || (row[7]||"") === m[1]);
                let blocks = Math.ceil(parseFloat((m[2]||"0").replace("h",""))/0.5);
                let isIng = (m[3]||"").toLowerCase().includes("ing");
                if(start === -1) return;

                for(let b=0; b<blocks; b++){
                    let r = start+b; if(r>=data.length) break;
                    let cRange = isIng ? [8,13] : [1,6];
                    if(m[4]==="QUITAR"){
                        for(let c=cRange[0]; c<=cRange[1]; c++) if(data[r][c].toLowerCase().includes(m[6].toLowerCase())) data[r][c] = "";
                    } else if(m[4]==="AÑADIR"){
                        for(let c=cRange[0]; c<=cRange[1]; c++) if(!data[r][c].trim()) { 
                            let tag = m[5].toLowerCase().includes("recup") ? " [REC]" : m[5].toLowerCase().includes("camb") ? " [CAM]" : " [EXT]";
                            data[r][c] = m[6] + tag; break; 
                        }
                    }
                }
            });

            // 3. Buscar al alumno
            data.forEach(row => {
                const cols = [[1,6, "Apoyo", row[0]], [8,13, "Inglés", row[7]]];
                cols.forEach(([s, e, mat, h]) => {
                    for(let c=s; c<=e; c++){
                        let v = (row[c]||"").trim();
                        if(v.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").includes(buscado)){
                            let tag = v.includes("[REC]") ? "RECUPERACIÓN" : v.includes("[CAM]") ? "CAMBIO" : v.includes("[EXT]") ? "EXTRA" : "";
                            clasesFinales.push({ dia, hora: h, materia: mat, tag });
                        }
                    }
                });
            });
        });

        // (Aquí sigue tu lógica original de pintar tarjetas, examenes y notas)
        // Solo recuerda que al pintar las tarjetas de horario, si tag !== "", añade un aviso visual.
        pintarResultado(clasesFinales, examenes, faltas, calend);
    }
    
    // (Resto de tus funciones originales de avisos, calendario, etc.)
</script>
</body>
</html>
