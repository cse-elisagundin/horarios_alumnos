<script>
    const _0x8F = "MDEwNTIz"; 
    let SISTEMA_DESBLOQUEADO = false; 
    
    // NOTA: He cambiado todos los enlaces a TSV para evitar errores con comas
    const urls = {
        "Lunes": "https://docs.google.com/spreadsheets/d/e/2PACX-1vTa_AjdQ-TzUs68ciZCnbgsUzqRF78m8e-oMrmbrorAsXjaFckYe6JQAzyKFlY6jcvWTMVZ3UDcqxMx/pub?gid=0&single=true&output=tsv",
        "Martes": "https://docs.google.com/spreadsheets/d/e/2PACX-1vTa_AjdQ-TzUs68ciZCnbgsUzqRF78m8e-oMrmbrorAsXjaFckYe6JQAzyKFlY6jcvWTMVZ3UDcqxMx/pub?gid=1905233272&single=true&output=tsv",
        "MiÃ©rcoles": "https://docs.google.com/spreadsheets/d/e/2PACX-1vTa_AjdQ-TzUs68ciZCnbgsUzqRF78m8e-oMrmbrorAsXjaFckYe6JQAzyKFlY6jcvWTMVZ3UDcqxMx/pub?gid=745373517&single=true&output=tsv",
        "Jueves": "https://docs.google.com/spreadsheets/d/e/2PACX-1vTa_AjdQ-TzUs68ciZCnbgsUzqRF78m8e-oMrmbrorAsXjaFckYe6JQAzyKFlY6jcvWTMVZ3UDcqxMx/pub?gid=314818236&single=true&output=tsv",
        "Viernes": "https://docs.google.com/spreadsheets/d/e/2PACX-1vTa_AjdQ-TzUs68ciZCnbgsUzqRF78m8e-oMrmbrorAsXjaFckYe6JQAzyKFlY6jcvWTMVZ3UDcqxMx/pub?gid=1396865785&single=true&output=tsv"
    };

    let memoriaCache = {}; 

    function leerHoja(url) {
        if (memoriaCache[url]) return Promise.resolve(memoriaCache[url]);
        return new Promise(resolve => {
            Papa.parse(url + "&t=" + Date.now(), { 
                download:true, 
                skipEmptyLines:true, 
                complete: res => { memoriaCache[url] = res.data; resolve(res.data); }, 
                error: e => { console.error("Error cargando", url); resolve([]); } 
            });
        });
    }

    function timeToMins(t) { if(!t) return 0; const [h, m] = t.split(':').map(Number); return h * 60 + m; }
    function minsToTime(m) { const hh = Math.floor(m / 60).toString().padStart(2,'0'); const mm = (m % 60).toString().padStart(2,'0'); return `${hh}:${mm}`; }
    function formatName(n) { return n.toLowerCase().replace(/(?:^|\s)\S/g, function(a) { return a.toUpperCase(); }); }

    function esNombreValido(texto) {
        if (!texto || texto.length < 2) return false;
        const t = texto.toUpperCase().trim();
        const prohibidos = ["HORA", "ALUMNO", "APOYO", "INGLÃ‰S", "INGLES", "CLASE", "LUNES", "MARTES", "MIERCOLES", "JUEVES", "VIERNES"];
        if (prohibidos.some(p => t.includes(p))) return false;
        if (/\d/.test(t) && t.includes(':')) return false;
        return true;
    }

    function agruparClases(clases) {
        if(clases.length === 0) return [];
        // Ordenamos por dÃ­a y hora antes de agrupar
        clases.sort((a, b) => {
            const diasOrden = ["Lunes", "Martes", "MiÃ©rcoles", "Jueves", "Viernes"];
            if (diasOrden.indexOf(a.dia) !== diasOrden.indexOf(b.dia)) return diasOrden.indexOf(a.dia) - diasOrden.indexOf(b.dia);
            return a.startMins - b.startMins;
        });

        let grupos = [];
        let actual = null;
        clases.forEach(clase => {
            const startMins = timeToMins(clase.h);
            if (actual) {
                // Si es el mismo dÃ­a, misma materia y la hora de inicio coincide con el final de la anterior
                if (actual.dia === clase.dia && actual.tipo === clase.tipo && startMins === actual.endMins) {
                    actual.endMins += 30; // Extendemos media hora
                    if (!actual.fullText.includes(clase.fullText)) {
                        actual.fullText += " / " + clase.fullText;
                    }
                    return;
                } else { grupos.push(actual); }
            }
            actual = { 
                dia: clase.dia, 
                startMins: startMins, 
                endMins: startMins + 30, 
                materia: clase.materia, 
                tipo: clase.tipo,
                fullText: clase.fullText,
                h: clase.h // Guardamos string original por si acaso
            };
        });
        if (actual) grupos.push(actual);
        return grupos;
    }

    async function ejecutarBusqueda(nombre) {
        document.getElementById('search-area').style.display = 'none';
        document.getElementById('loading-spinner').style.display = 'block';
        document.getElementById('resultado').innerHTML = '';
        const nombreBuscado = nombre.toLowerCase().trim();
        const dias = Object.keys(urls);
        const promesas = dias.map(dia => leerHoja(urls[dia]));
        const resultados = await Promise.all(promesas);
        
        let clasesRaw = [];

        dias.forEach((dia, idx) => {
            const data = resultados[idx];
            if(!data) return;
            
            data.forEach(row => {
                // ==========================================
                // BLOQUE 1: APOYO (Hora en Col A [0], Alumnos en B-G [1-6])
                // ==========================================
                let horaApoyo = (row[0] || "").trim().substring(0,5);
                if(horaApoyo && horaApoyo.includes(":")) {
                    for(let c=1; c<=6; c++) { // Columnas B a G
                        let val = row[c] || "";
                        if(esNombreValido(val) && val.toLowerCase().includes(nombreBuscado)) {
                            clasesRaw.push({
                                dia, h: horaApoyo, materia: "Apoyo", tipo: "apoyo", fullText: val 
                            });
                        }
                    }
                }

                // ==========================================
                // BLOQUE 2: INGLÃ‰S (Hora en Col H [7], Alumnos en I-N [8-13])
                // ==========================================
                let horaIngles = (row[7] || "").trim().substring(0,5);
                if(horaIngles && horaIngles.includes(":")) {
                    for(let c=8; c<=13; c++) { // Columnas I a N
                        let val = row[c] || "";
                        if(esNombreValido(val) && val.toLowerCase().includes(nombreBuscado)) {
                            clasesRaw.push({
                                dia, h: horaIngles, materia: "InglÃ©s", tipo: "ingles", fullText: val 
                            });
                        }
                    }
                }
            });
        });

        document.getElementById('loading-spinner').style.display = 'none';
        
        if(clasesRaw.length > 0) {
            const clasesAgrupadas = agruparClases(clasesRaw);
            
            let html = `<h3 style="color:var(--c-primary); margin-bottom:20px; font-family:'Outfit', sans-serif; font-weight: 700;">
                        Horario de <span style="color:var(--c-accent); font-family:'Schoolbell', cursive; text-shadow: 1px 1px 2px rgba(0,0,0,0.15); letter-spacing: 0.5px; font-size:1.1em;">${formatName(nombre)}</span>
                        </h3>`;
            
            clasesAgrupadas.forEach(item => {
                const horarioTexto = `${minsToTime(item.startMins)} - ${minsToTime(item.endMins)}`;
                html += `
                    <div class="result-card type-${item.tipo}">
                        <div class="card-info">
                            <span class="card-day">${item.dia}</span>
                            <div class="card-time-wrapper">
                                <div class="clock-icon"></div>
                                <span class="card-time">${horarioTexto}</span>
                            </div>
                        </div>
                        <span class="badge bg-${item.tipo}">${item.materia}</span>
                    </div>`;
            });
            document.getElementById('resultado').innerHTML = html;
            document.getElementById('actions-panel').style.display = 'block';

            if(SISTEMA_DESBLOQUEADO) {
                document.getElementById('btnCopiar').style.display = 'block';
                document.getElementById('btnDirectorio').style.display = 'block';
                document.getElementById('btnReset').style.display = 'block'; 
            } else {
                document.getElementById('btnCopiar').style.display = 'none';
                document.getElementById('btnDirectorio').style.display = 'none';
                document.getElementById('btnReset').style.display = 'none'; 
            }
        } else {
            document.getElementById('error-msg').innerText = "No hemos encontrado ese nombre.";
            document.getElementById('error-msg').style.display = 'block';
            document.getElementById('search-area').style.display = 'block';
        }
    }

    async function cargarDirectorio() {
        const area = document.getElementById('directory-area');
        const inputDir = document.getElementById('dirSearchInput');
        
        area.innerHTML = "Cargando..."; area.style.display = 'block';
        inputDir.style.display = 'block'; 
        inputDir.focus();

        const promesas = Object.values(urls).map(url => leerHoja(url));
        const resultados = await Promise.all(promesas);
        let alumnos = new Set();
        
        resultados.forEach(data => {
            if(!data) return;
            data.forEach(row => {
                // Escanear bloque Apoyo (Indices 1 a 6)
                for(let c=1; c<=6; c++){
                    let txt = (row[c] || "").trim();
                    if(esNombreValido(txt)) alumnos.add(txt.toLowerCase());
                }
                // Escanear bloque InglÃ©s (Indices 8 a 13)
                for(let c=8; c<=13; c++){
                    let txt = (row[c] || "").trim();
                    if(esNombreValido(txt)) alumnos.add(txt.toLowerCase());
                }
            });
        });
        
        let html = "";
        Array.from(alumnos).sort().forEach(n => {
            html += `<span class="student-chip" onclick="seleccionarAlumno('${n}')">${n}</span>`;
        });
        area.innerHTML = html;
    }

    window.filtrarDirectorio = () => {
        const input = document.getElementById('dirSearchInput');
        const filtro = input.value.toLowerCase();
        const chips = document.querySelectorAll('.student-chip');
        chips.forEach(chip => {
            const txt = chip.textContent.toLowerCase();
            chip.style.display = txt.includes(filtro) ? 'inline-block' : 'none';
        });
    };

    window.seleccionarAlumno = n => { document.getElementById('magicInput').value = n; ejecutarBusqueda(n); };

    document.addEventListener('DOMContentLoaded', () => {
        const input = document.getElementById('magicInput');
        const btn = document.getElementById('btnBuscar');
        const btnCopiar = document.getElementById('btnCopiar');

        const login = () => {
            const val = input.value.trim();
            if(!val) return;
            if(!SISTEMA_DESBLOQUEADO && btoa(val) === _0x8F) {
                SISTEMA_DESBLOQUEADO = true;
                document.getElementById('status-indicator').innerText = "ðŸ”“ MODO ACADEMIA";
                input.value = ""; input.placeholder = "Nombre del alumno...";
                document.getElementById('actions-panel').style.display = 'block';
            } else { 
                ejecutarBusqueda(val); 
            }
        };

        btn.onclick = login;
        input.onkeypress = e => { if(e.key === 'Enter') login(); };
        document.getElementById('btnDirectorio').onclick = cargarDirectorio;
        document.getElementById('btnReset').onclick = () => location.reload();

        btnCopiar.onclick = () => {
            const url = window.location.href.split('?')[0] + "?alumno=" + encodeURIComponent(input.value.trim());
            navigator.clipboard.writeText(url).then(() => { 
                const original = btnCopiar.innerText;
                btnCopiar.innerText = "âœ… ENLACE COPIADO";
                setTimeout(() => btnCopiar.innerText = original, 2000);
            });
        };
        
        const p = new URLSearchParams(window.location.search).get('alumno');
        if(p) { input.value = p; ejecutarBusqueda(p); }
    });
</script>
