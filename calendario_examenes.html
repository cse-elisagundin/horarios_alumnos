<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario de Ex√°menes CSE</title>
    <link rel="icon" type="image/png" href="https://github.com/cse-elisagundin/horarios_alumnos/blob/main/image.png?raw=true">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <style>
        :root { 
            --c-primary: #243c7a; 
            --c-accent: #fa65c3; 
            --bg-body: #f4f6f9; 
            --bg-card: #ffffff;
        }

        body { font-family: 'Segoe UI', Roboto, sans-serif; background-color: var(--bg-body); margin: 0; padding: 20px; color: #333; }
        
        .container { max-width: 1200px; margin: 0 auto; background: var(--bg-card); padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(36, 60, 122, 0.1); }

        /* HEADER */
        header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; margin-bottom: 30px; border-bottom: 2px solid #eee; padding-bottom: 20px; }
        
        .brand { display: flex; align-items: center; gap: 15px; }
        .brand img { height: 50px; }
        .brand h1 { margin: 0; color: var(--c-primary); font-size: 24px; text-transform: uppercase; }

        /* CONTROLES */
        .controls { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        
        /* Estilo personalizado para el Select2 (Desplegable) */
        .select2-container .select2-selection--single {
            height: 40px !important;
            border-radius: 50px !important;
            border: 2px solid #eee !important;
            padding: 5px 15px;
            display: flex;
            align-items: center;
        }
        .select2-container--default .select2-selection--single .select2-selection__arrow { top: 7px !important; right: 10px !important; }

        /* NAVEGACI√ìN MES */
        .month-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: var(--c-primary); color: white; padding: 15px; border-radius: 12px; }
        .nav-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .nav-btn:hover { background: var(--c-accent); }
        .current-month { font-size: 20px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; }

        /* CALENDARIO GRID */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; }
        
        .day-name { text-align: center; font-weight: bold; color: #888; text-transform: uppercase; font-size: 12px; padding-bottom: 10px; }

        .calendar-day { 
            background: #fff; border: 1px solid #eee; border-radius: 10px; min-height: 120px; padding: 10px; 
            transition: all 0.2s; position: relative; display: flex; flex-direction: column; gap: 5px;
        }
        .calendar-day.today { border: 2px solid var(--c-accent); background: #fff0f8; }
        .day-number { font-weight: 900; color: #ddd; font-size: 24px; position: absolute; top: 10px; right: 10px; line-height: 1; }
        .calendar-day.today .day-number { color: var(--c-accent); }
        .spacer-num { height: 25px; } 

        /* EVENTOS (CHIPS) */
        .event-chip { 
            display: block; background: var(--c-primary); color: white; padding: 6px 8px; 
            border-radius: 6px; font-size: 11px; border-left: 3px solid var(--c-accent);
            cursor: pointer; transition: 0.2s;
        }
        .event-chip:hover { transform: scale(1.02); filter: brightness(1.2); }
        
        .asig-text { font-weight: 800; display: block; font-size: 12px; margin-bottom: 2px; }
        .alum-text { opacity: 0.9; font-size: 10px; display: block; }
        
        /* Ocultar eventos que no coincidan con el filtro */
        .event-chip.filtered-out { display: none; } 
        .event-chip.highlight { box-shadow: 0 0 0 2px var(--c-accent); transform: scale(1.05); z-index: 10; }

        .loading { text-align: center; padding: 50px; color: #999; font-style: italic; grid-column: 1 / -1; }

        @media (max-width: 768px) {
            .brand h1 { display: none; } 
            .calendar-grid { grid-template-columns: 1fr; }
            .calendar-day { min-height: auto; }
            .day-name, .empty-day, .spacer-num { display: none; }
            .day-number { position: relative; top: auto; right: auto; text-align: left; margin-bottom: 5px; font-size: 18px; color: var(--c-primary); }
            .controls { width: 100%; }
            .select2-container { width: 100% !important; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="brand">
            <img src="https://github.com/cse-elisagundin/horarios_alumnos/blob/main/image.png?raw=true" alt="Logo CSE">
            <h1>Ex√°menes</h1>
        </div>
        <div class="controls">
            <select id="alumnoSelect" style="width: 300px;">
                <option value="todos">üë• Todos los alumnos</option>
            </select>
        </div>
    </header>

    <div class="month-nav">
        <button class="nav-btn" onclick="cambiarMes(-1)">&#10094; ANTERIOR</button>
        <span class="current-month" id="monthDisplay">CARGANDO...</span>
        <button class="nav-btn" onclick="cambiarMes(1)">SIGUIENTE &#10095;</button>
    </div>

    <div id="calendar" class="calendar-grid">
        <div class="loading">Cargando ex√°menes...</div>
    </div>
</div>

<script>
    // ==========================================
    // üîó TUS ENLACES CONFIGURADOS
    // ==========================================
    const CSV_EXAMENES = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRrK53aJ-n_g-6-yrsASWYrkCc47WpA3uKQGXvuixv0OZ5BkzbTRJrDI0Sat2qxKRvX7NdOsjlsFrpR/pub?gid=0&single=true&output=csv";
    const CSV_ALUMNOS  = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQQZF-mJ-JVs1nimm4uu9UV0ibMcXhhEnZZjbrGLWJO4YspYonC9vu1vIywZQLTxsvgw2GPv7wATNZL/pub?gid=130634044&single=true&output=csv";
    // ==========================================

    let examenes = [];
    let alumnosLista = [];
    let mesVisualizado = new Date();

    $(document).ready(function() {
        // Inicializar Select2 (Buscador bonito)
        $('#alumnoSelect').select2({
            placeholder: "Buscar alumno...",
            allowClear: false
        });

        // Al cambiar el alumno en el desplegable, filtrar el calendario
        $('#alumnoSelect').on('change', function() {
            renderCalendario();
        });

        // Empezar la carga de datos
        initApp();
    });

    function initApp() {
        // 1. Cargar Lista de Alumnos
        Papa.parse(CSV_ALUMNOS + "&t=" + Date.now(), {
            download: true,
            header: false,
            complete: function(res) {
                // Leer Columna A, quitar vac√≠os y cabeceras si las hay
                let raw = res.data.map(r => r[0]).filter(n => n && n.trim() !== "" && n.toLowerCase() !== "nombre");
                
                // Quitar duplicados y ordenar A-Z
                alumnosLista = [...new Set(raw)].sort(); 
                
                llenarSelectAlumnos();
                
                // 2. Una vez tenemos alumnos, cargamos los ex√°menes
                cargarExamenes();
            },
            error: function(err) {
                console.error("Error Alumnos:", err);
            }
        });
    }

    function llenarSelectAlumnos() {
        const select = $('#alumnoSelect');
        alumnosLista.forEach(nombre => {
            select.append(new Option(nombre, nombre));
        });
    }

    function cargarExamenes() {
        Papa.parse(CSV_EXAMENES + "&t=" + Date.now(), {
            download: true,
            header: false,
            complete: function(results) {
                procesarExamenes(results.data);
                renderCalendario();
            },
            error: function(err) {
                console.error("Error Ex√°menes:", err);
                document.getElementById('calendar').innerHTML = "<div class='loading'>Error cargando datos.</div>";
            }
        });
    }

    function procesarExamenes(data) {
        // A=Fecha, B=Asignatura, C=Alumno. Saltamos fila 0 headers.
        examenes = data.slice(1).map(row => {
            if(!row[0]) return null;
            return {
                fecha: row[0].trim(),
                asignatura: (row[1] || "").trim(),
                alumno: (row[2] || "").trim()
            };
        }).filter(item => item !== null);
    }

    function renderCalendario() {
        const grid = document.getElementById('calendar');
        grid.innerHTML = "";

        // ¬øQu√© alumno estamos buscando?
        const alumnoSeleccionado = $('#alumnoSelect').val();

        const year = mesVisualizado.getFullYear();
        const month = mesVisualizado.getMonth();
        
        // Actualizar t√≠tulo mes
        const nombreMes = mesVisualizado.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
        document.getElementById('monthDisplay').textContent = nombreMes;

        // Cabeceras d√≠as
        ["Lun", "Mar", "Mi√©", "Jue", "Vie", "S√°b", "Dom"].forEach(dia => {
            const div = document.createElement('div');
            div.className = "day-name";
            div.textContent = dia;
            grid.appendChild(div);
        });

        const primerDiaMes = new Date(year, month, 1);
        const diasEnMes = new Date(year, month + 1, 0).getDate();
        
        // Ajuste para empezar en Lunes (0=Domingo -> 6)
        let diaInicioSemana = primerDiaMes.getDay() - 1; 
        if(diaInicioSemana === -1) diaInicioSemana = 6;

        // Relleno d√≠as vac√≠os al principio
        for(let i = 0; i < diaInicioSemana; i++) {
            const empty = document.createElement('div');
            empty.className = "calendar-day empty-day";
            empty.style.background = "transparent";
            empty.style.border = "none";
            grid.appendChild(empty);
        }

        // Pintar d√≠as del mes
        const hoyStr = new Date().toISOString().split('T')[0];

        for(let dia = 1; dia <= diasEnMes; dia++) {
            const celda = document.createElement('div');
            celda.className = "calendar-day";
            
            const fechaStr = `${year}-${String(month+1).padStart(2,'0')}-${String(dia).padStart(2,'0')}`;
            if(fechaStr === hoyStr) celda.classList.add('today');

            // N√∫mero d√≠a
            const num = document.createElement('div');
            num.className = "day-number";
            num.textContent = dia;
            celda.appendChild(num);
            
            celda.appendChild(document.createElement('div')); // Spacer

            // FILTRAR EVENTOS
            const eventosDia = examenes.filter(ex => {
                const coincideFecha = ex.fecha === fechaStr;
                const coincideAlumno = (alumnoSeleccionado === "todos") || (ex.alumno === alumnoSeleccionado);
                return coincideFecha && coincideAlumno;
            });
            
            eventosDia.forEach(ex => {
                const chip = document.createElement('div');
                chip.className = "event-chip";
                chip.innerHTML = `<span class="asig-text">${ex.asignatura}</span><span class="alum-text">${ex.alumno}</span>`;
                celda.appendChild(chip);
            });

            grid.appendChild(celda);
        }
    }

    function cambiarMes(delta) {
        mesVisualizado.setMonth(mesVisualizado.getMonth() + delta);
        renderCalendario();
    }
</script>

</body>
</html>
