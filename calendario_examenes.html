<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario de Exámenes CSE</title>
    <link rel="icon" type="image/png" href="https://github.com/cse-elisagundin/horarios_alumnos/blob/main/image.png?raw=true">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <style>
        :root { 
            --c-primary: #243c7a; /* Azul CSE */
            --c-accent: #fa65c3;  /* Rosa CSE */
            --bg-body: #f4f6f9; 
            --bg-card: #ffffff;
        }

        body { font-family: 'Segoe UI', Roboto, sans-serif; background-color: var(--bg-body); margin: 0; padding: 20px; color: #333; }
        
        .container { max-width: 1200px; margin: 0 auto; background: var(--bg-card); padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(36, 60, 122, 0.1); }

        /* HEADER */
        header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; margin-bottom: 30px; border-bottom: 2px solid #eee; padding-bottom: 20px; }
        
        .brand { display: flex; align-items: center; gap: 15px; }
        .brand img { height: 50px; }
        .brand h1 { margin: 0; color: var(--c-primary); font-size: 24px; text-transform: uppercase; }

        /* CONTROLES */
        .controls { display: flex; gap: 10px; align-items: center; }
        .search-box { padding: 10px 15px; border: 2px solid #eee; border-radius: 50px; width: 250px; font-size: 14px; outline: none; transition: 0.3s; }
        .search-box:focus { border-color: var(--c-accent); }

        /* NAVEGACIÓN MES */
        .month-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: var(--c-primary); color: white; padding: 15px; border-radius: 12px; }
        .nav-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .nav-btn:hover { background: var(--c-accent); }
        .current-month { font-size: 20px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; }

        /* CALENDARIO GRID */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; }
        
        .day-name { text-align: center; font-weight: bold; color: #888; text-transform: uppercase; font-size: 12px; padding-bottom: 10px; }

        .calendar-day { 
            background: #fff; border: 1px solid #eee; border-radius: 10px; min-height: 120px; padding: 10px; 
            transition: all 0.2s; position: relative; display: flex; flex-direction: column; gap: 5px;
        }
        .calendar-day.today { border: 2px solid var(--c-accent); background: #fff0f8; }
        .calendar-day:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); z-index: 5; }
        .day-number { font-weight: 900; color: #ddd; font-size: 24px; position: absolute; top: 10px; right: 10px; line-height: 1; }
        .calendar-day.today .day-number { color: var(--c-accent); }
        
        /* Espaciador para que el número no tape los eventos */
        .spacer-num { height: 25px; } 

        /* EVENTOS (CHIPS) */
        .event-chip { 
            display: block; background: var(--c-primary); color: white; padding: 6px 8px; 
            border-radius: 6px; font-size: 11px; border-left: 3px solid var(--c-accent);
            cursor: pointer; transition: 0.2s;
        }
        .event-chip:hover { transform: scale(1.02); filter: brightness(1.2); }
        
        .asig-text { font-weight: 800; display: block; font-size: 12px; margin-bottom: 2px; }
        .alum-text { opacity: 0.9; font-size: 10px; display: block; }
        
        .event-chip.filtered-out { opacity: 0.1; } 
        .event-chip.highlight { box-shadow: 0 0 0 2px var(--c-accent); transform: scale(1.05); z-index: 10; }

        .loading { text-align: center; padding: 50px; color: #999; font-style: italic; grid-column: 1 / -1; }

        @media (max-width: 768px) {
            .calendar-grid { grid-template-columns: 1fr; }
            .calendar-day { min-height: auto; }
            .day-name { display: none; }
            .empty-day { display: none; }
            .day-number { position: relative; top: auto; right: auto; text-align: left; margin-bottom: 5px; font-size: 18px; color: var(--c-primary); }
            .spacer-num { display: none; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="brand">
            <img src="https://github.com/cse-elisagundin/horarios_alumnos/blob/main/image.png?raw=true" alt="Logo CSE">
            <h1>Exámenes</h1>
        </div>
        <div class="controls">
            <input type="text" id="searchInput" class="search-box" placeholder="Buscar alumno o asignatura..." onkeyup="filtrarEventos()">
        </div>
    </header>

    <div class="month-nav">
        <button class="nav-btn" onclick="cambiarMes(-1)">&#10094; ANTERIOR</button>
        <span class="current-month" id="monthDisplay">CARGANDO...</span>
        <button class="nav-btn" onclick="cambiarMes(1)">SIGUIENTE &#10095;</button>
    </div>

    <div id="calendar" class="calendar-grid">
        <div class="loading">Cargando exámenes...</div>
    </div>
</div>

<script>
    // ==========================================
    // ENLACE CSV DE GOOGLE SHEETS
    // ==========================================
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRrK53aJ-n_g-6-yrsASWYrkCc47WpA3uKQGXvuixv0OZ5BkzbTRJrDI0Sat2qxKRvX7NdOsjlsFrpR/pub?gid=0&single=true&output=csv"; 
    // ==========================================

    let examenes = [];
    let fechaActual = new Date();
    let mesVisualizado = new Date();

    function init() {
        Papa.parse(CSV_URL + "&t=" + Date.now(), {
            download: true,
            header: false, 
            complete: function(results) {
                procesarDatos(results.data);
                renderCalendario();
            },
            error: function(err) {
                console.error("Error CSV:", err);
                document.getElementById('calendar').innerHTML = "<div class='loading'>Error cargando datos. Revisa que el enlace sea público.</div>";
            }
        });
    }

    function procesarDatos(data) {
        // Estructura: A=Fecha, B=Asignatura, C=Alumno
        // Saltamos fila 0 (encabezados)
        examenes = data.slice(1).map(row => {
            // Validamos que haya fecha (columna 0)
            if(!row[0]) return null;
            return {
                fecha: row[0].trim(),      // Columna A
                asignatura: (row[1] || "").trim(), // Columna B
                alumno: (row[2] || "").trim()      // Columna C
            };
        }).filter(item => item !== null);
    }

    function renderCalendario() {
        const grid = document.getElementById('calendar');
        grid.innerHTML = "";

        const year = mesVisualizado.getFullYear();
        const month = mesVisualizado.getMonth();

        // Título del mes
        const nombreMes = mesVisualizado.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
        document.getElementById('monthDisplay').textContent = nombreMes;

        // Cabeceras días
        const diasSemana = ["Lun", "Mar", "Mié", "Jue", "Vie", "Sáb", "Dom"];
        diasSemana.forEach(dia => {
            const div = document.createElement('div');
            div.className = "day-name";
            div.textContent = dia;
            grid.appendChild(div);
        });

        // Cálculos del mes
        const primerDiaMes = new Date(year, month, 1);
        const diasEnMes = new Date(year, month + 1, 0).getDate();
        
        // Ajuste Lunes (0=Domingo -> queremos 0=Lunes)
        let diaInicioSemana = primerDiaMes.getDay() - 1; 
        if(diaInicioSemana === -1) diaInicioSemana = 6;

        // Huecos vacíos principio
        for(let i = 0; i < diaInicioSemana; i++) {
            const empty = document.createElement('div');
            empty.className = "calendar-day empty-day";
            empty.style.background = "transparent";
            empty.style.border = "none";
            grid.appendChild(empty);
        }

        // Días reales
        const hoyStr = new Date().toISOString().split('T')[0];

        for(let dia = 1; dia <= diasEnMes; dia++) {
            const celda = document.createElement('div');
            celda.className = "calendar-day";
            
            // Construir fecha YYYY-MM-DD para comparar
            const fechaStr = `${year}-${String(month+1).padStart(2,'0')}-${String(dia).padStart(2,'0')}`;
            
            if(fechaStr === hoyStr) celda.classList.add('today');

            // Número y espaciador
            const num = document.createElement('div');
            num.className = "day-number";
            num.textContent = dia;
            celda.appendChild(num);
            
            const spacer = document.createElement('div');
            spacer.className = "spacer-num";
            celda.appendChild(spacer);

            // Filtrar eventos de HOY
            const eventosDia = examenes.filter(ex => ex.fecha === fechaStr);
            
            eventosDia.forEach(ex => {
                const chip = document.createElement('div');
                chip.className = "event-chip";
                // Datos para el buscador
                chip.setAttribute('data-search', (ex.alumno + " " + ex.asignatura).toLowerCase());
                
                chip.innerHTML = `
                    <span class="asig-text">${ex.asignatura}</span>
                    <span class="alum-text">${ex.alumno}</span>
                `;
                celda.appendChild(chip);
            });

            grid.appendChild(celda);
        }
        
        filtrarEventos(); 
    }

    function cambiarMes(delta) {
        mesVisualizado.setMonth(mesVisualizado.getMonth() + delta);
        renderCalendario();
    }

    function filtrarEventos() {
        const texto = document.getElementById('searchInput').value.toLowerCase();
        const chips = document.querySelectorAll('.event-chip');

        chips.forEach(chip => {
            const data = chip.getAttribute('data-search');
            if(data.includes(texto)) {
                chip.classList.remove('filtered-out');
                if(texto.length > 0) chip.classList.add('highlight');
                else chip.classList.remove('highlight');
            } else {
                chip.classList.add('filtered-out');
                chip.classList.remove('highlight');
            }
        });
    }

    // Arrancar
    init();

</script>

</body>
</html>
