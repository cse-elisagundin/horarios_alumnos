<script>
    const { createApp } = Vue;

    // --- CONFIGURACIÓN DE SEGURIDAD ---
    const PASS_HASH = "MDEwNTIz"; 
    const ENCRYPTED_URL = "aHR0cHM6Ly9zY3JpcHQuZ29vZ2xlLmNvbS9tYWNyb3Mvcy9BS2Z5Y2J6T3hlWmIzTVotY21WZG5GMjBERmtXN0Vrem9aeXVLNlp3bExpSmltbWdsYjVpTXJDV3NCQWdGYndXTXJGN25ja3kvZXhlYw==";

    createApp({
        data() {
            return {
                authenticated: false,
                passwordInput: '',
                loginError: false,
                apiUrl: '', 
                
                list: [],
                search: '',
                selected: null, // Controla si se ve el formulario
                isNew: false,
                loading: false,
                saving: false,
                
                showSuccess: false,
                successMessage: '',
                
                form: {}
            }
        },
        computed: {
            filteredList() {
                if (!this.search) return this.list;
                const t = this.search.toLowerCase();
                return this.list.filter(s => 
                    (s.nombre && s.nombre.toLowerCase().includes(t)) || 
                    (s.apellidos && s.apellidos.toLowerCase().includes(t)) ||
                    (s.dni && String(s.dni).toLowerCase().includes(t))
                );
            }
        },
        methods: {
            login() {
                if (btoa(this.passwordInput) === PASS_HASH) {
                    this.authenticated = true;
                    this.loginError = false;
                    this.apiUrl = atob(ENCRYPTED_URL);
                    this.loadData();
                } else {
                    this.loginError = true;
                    this.passwordInput = '';
                }
            },
            logout() {
                this.authenticated = false;
                this.passwordInput = '';
                this.list = [];
                this.selected = null;
                this.apiUrl = ''; 
            },
            async loadData() {
                this.loading = true;
                try {
                    const res = await fetch(this.apiUrl);
                    const json = await res.json();
                    if (json.status === 'success') {
                        // Asignamos los datos
                        this.list = json.data.sort((a, b) => {
                            // Protección extra por si algún apellido viene vacío
                            let apA = a.apellidos || "";
                            let apB = b.apellidos || "";
                            return apA.localeCompare(apB);
                        });
                    }
                } catch (e) { 
                    console.error("Error cargando datos:", e);
                    alert("Error de conexión. Revisa la consola."); 
                }
                this.loading = false;
            },
            createNew() {
                this.isNew = true;
                this.form = { 
                    nombre:'', apellidos:'', dni:'', nacimiento:'',
                    direccion:'', cp:'', poblacion:'', provincia:'',
                    colegio:'', curso:'', tlf:'', email:'',
                    fam1_nombre:'', fam1_relacion:'', fam1_tlf:'', fam1_email:'',
                    fam2_nombre:'', fam2_relacion:'', fam2_tlf:'', fam2_email:''
                };
                this.selected = { id: 'TEMP' }; 
            },
            
            // --- AQUÍ ESTABA EL PROBLEMA, ESTA ES LA VERSIÓN CORREGIDA ---
            selectStudent(s) {
                console.log("Intentando abrir:", s); // Verás esto en la consola (F12)
                
                this.isNew = false;
                
                // 1. Copiamos los datos del alumno a una variable temporal 'tempForm'
                // Usamos JSON parse/stringify para romper referencias y evitar errores raros
                let tempForm = {};
                try {
                    tempForm = JSON.parse(JSON.stringify(s));
                } catch(e) {
                    tempForm = { ...s }; // Fallback simple
                }

                // 2. Intentamos arreglar la fecha sin que explote el programa
                try {
                    if (tempForm.nacimiento) {
                        // Google Sheets a veces manda la fecha como texto largo ISO (2010-05-15T00:00:00.000Z)
                        // Cortamos en la 'T' para quedarnos solo con la parte YYYY-MM-DD
                        if (typeof tempForm.nacimiento === 'string' && tempForm.nacimiento.includes('T')) {
                             tempForm.nacimiento = tempForm.nacimiento.split('T')[0];
                        } 
                        // Si viene como objeto fecha o string raro, intentamos convertirlo
                        else {
                            let d = new Date(tempForm.nacimiento);
                            // Si es una fecha válida
                            if (!isNaN(d.getTime())) {
                                tempForm.nacimiento = d.toISOString().split('T')[0];
                            } else {
                                // Si la fecha es inválida, la dejamos vacía para que no falle el input
                                console.warn("Fecha inválida detectada:", tempForm.nacimiento);
                                tempForm.nacimiento = '';
                            }
                        }
                    }
                } catch(err) {
                    console.error("Error procesando fecha, se dejará vacía:", err);
                    tempForm.nacimiento = ''; // En caso de duda, limpiar fecha
                }

                // 3. Asignamos al formulario y activamos la vista
                this.form = tempForm;
                this.selected = s; // ESTO ES LO QUE HACE QUE SE ABRA EL PANEL
            },

            async saveData() {
                this.saving = true;
                const payload = { ...this.form, action: this.isNew ? 'create' : 'update', id: this.selected.id };
                try {
                    await fetch(this.apiUrl, { method: 'POST', body: JSON.stringify(payload) });
                    
                    this.showSuccess = true;
                    this.successMessage = this.isNew ? 'Alumno creado correctamente' : 'Ficha actualizada';
                    
                    setTimeout(() => {
                        this.showSuccess = false;
                        this.selected = null; 
                        this.loadData();
                        this.saving = false;
                    }, 2000);
                } catch (e) { 
                    alert('Error al conectar con Google Sheets'); 
                    this.saving = false; 
                }
            }
        }
    }).mount('#app');
</script>
