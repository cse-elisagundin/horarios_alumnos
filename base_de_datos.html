<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión CSE Elisa Gundín</title>
    <link rel="icon" type="image/png" href="https://github.com/cse-elisagundin/horarios_alumnos/blob/main/image.png?raw=true">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --c-primary: #243c7a; --c-secondary: #2b94cc; --c-accent: #fa65c3; --bg-body: #f4f6f9; }
        body { font-family: 'Outfit', sans-serif; background-color: var(--bg-body); }
        .login-container { background: white; border-radius: 20px; box-shadow: 0 15px 35px rgba(36, 60, 122, 0.12); }
        .btn-corp { background-color: var(--c-primary); transition: 0.3s; }
        .btn-corp:hover { background-color: #1a2e5e; transform: translateY(-2px); }
        .input-corp { border: 2px solid #e1e9f0; transition: 0.3s; color: var(--c-primary); font-weight: 600; }
        .input-corp:focus { border-color: var(--c-secondary); outline: none; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .pop-enter-active, .pop-leave-active { transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .pop-enter-from, .pop-leave-to { opacity: 0; transform: scale(0.8) translateY(20px); }
        @keyframes loading-bar { 0% { transform: translateX(-100%); } 100% { transform: translateX(300%); } }
        .loading-line { position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: #e0e7ff; overflow: hidden; }
        .loading-progress { height: 100%; width: 40%; background: var(--c-accent); animation: loading-bar 1.2s infinite linear; }
    </style>
</head>
<body class="h-screen overflow-hidden text-sm">

<div id="app" class="h-full flex flex-col relative">

    <transition name="pop">
        <div v-if="showSuccess" class="fixed inset-0 z-[100] flex items-center justify-center pointer-events-none">
            <div class="bg-white px-8 py-6 rounded-2xl shadow-2xl border-l-8 border-[#25D366] flex flex-col items-center gap-3 min-w-[300px]">
                <div class="bg-green-100 p-3 rounded-full text-[#25D366]"><i class="fas fa-check text-3xl"></i></div>
                <h3 class="text-xl font-extrabold text-[#243c7a] uppercase">¡Guardado!</h3>
                <p class="text-gray-500 font-semibold">{{ successMessage }}</p>
            </div>
        </div>
    </transition>

    <transition name="fade">
        <div v-if="!authenticated" class="fixed inset-0 z-50 flex items-center justify-center bg-[#f4f6f9] p-4">
            <div class="login-container p-10 w-full max-w-md text-center relative overflow-hidden">
                <div v-if="loading" class="loading-line"><div class="loading-progress"></div></div>
                <div class="mb-6 mt-2">
                    <img src="https://github.com/cse-elisagundin/horarios_alumnos/blob/main/image.png?raw=true" class="h-20 mx-auto mb-2 object-contain">
                    <div class="h-1 w-20 mx-auto mt-4 bg-gradient-to-r from-[#243c7a] via-[#2b94cc] to-[#fa65c3] rounded-full"></div>
                </div>
                <h2 class="text-2xl font-extrabold text-[#243c7a] mb-2 uppercase">Acceso Privado</h2>
                <input type="password" v-model="passwordInput" @keyup.enter="login" placeholder="Contraseña..." class="w-full p-4 rounded-xl input-corp text-center text-lg mb-4 bg-gray-50">
                <button @click="login" class="w-full py-4 text-white font-bold rounded-xl btn-corp uppercase shadow-lg">Entrar</button>
                <p v-if="loginError" class="mt-4 text-red-500 font-bold text-xs animate-pulse">⚠️ Contraseña incorrecta</p>
                <p v-if="loading" class="mt-4 text-xs text-gray-400 animate-pulse">Sincronizando base de datos...</p>
            </div>
        </div>
    </transition>

    <div v-if="authenticated" class="flex h-full animate-opacity duration-700">
        <div class="w-1/4 bg-white border-r flex flex-col shadow-xl z-20">
            <div class="p-5 bg-[#243c7a] text-white">
                <div class="flex items-center gap-3">
                    <div class="bg-white p-1 rounded-lg shadow-sm">
                        <img src="https://github.com/cse-elisagundin/horarios_alumnos/blob/main/image.png?raw=true" class="h-8 w-auto object-contain">
                    </div>
                    <h1 class="font-bold text-lg leading-tight">Gestión<br><span class="text-[#fa65c3]">Alumnos</span></h1>
                </div>
            </div>
            <div class="p-4 bg-gray-50 border-b space-y-3">
                <div class="relative">
                    <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                    <input v-model="search" type="text" placeholder="Buscar..." class="w-full pl-9 pr-8 p-2.5 rounded-lg border focus:border-[#2b94cc] outline-none shadow-sm">
                    <button v-if="search" @click="search = ''" class="absolute right-3 top-3 text-gray-400 hover:text-red-500">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="flex items-center gap-2 text-xs text-gray-500 px-1 select-none">
                    <input type="checkbox" v-model="showInactive" id="showInactive" class="rounded text-[#fa65c3] focus:ring-[#fa65c3] cursor-pointer">
                    <label for="showInactive" class="cursor-pointer hover:text-[#243c7a]">Ver alumnos de baja</label>
                </div>
                <button @click="createNew" class="w-full bg-[#2b94cc] text-white py-2.5 rounded-lg hover:bg-[#207bb0] font-bold flex justify-center gap-2 shadow">
                    <i class="fas fa-plus"></i> Nueva Ficha
                </button>
            </div>
            <div class="flex-1 overflow-y-auto">
                <div v-for="s in filteredList" :key="s.id" @click="selectStudent(s)"
                     class="p-4 border-b hover:bg-blue-50 cursor-pointer transition relative"
                     :class="[selected && selected.id === s.id ? 'bg-blue-50 border-l-4 border-l-[#fa65c3]' : '', s.baja ? 'opacity-60 bg-gray-50' : '']">
                    <div class="flex justify-between items-start">
                        <div class="font-bold text-base" :class="s.baja ? 'text-gray-500 line-through' : 'text-[#243c7a]'">{{ s.apellidos }}, {{ s.nombre }}</div>
                        <span v-if="s.baja" class="bg-gray-200 text-gray-500 text-[9px] px-1.5 py-0.5 rounded font-bold">BAJA</span>
                    </div>
                    <div class="text-xs text-gray-500 mt-1 flex justify-between uppercase">
                        <span>{{ s.curso }}</span><span>{{ s.dni }}</span>
                    </div>
                </div>
            </div>
            <div class="p-2 border-t bg-gray-50 text-center">
                <button @click="logout" class="text-xs font-bold text-gray-400 hover:text-red-500">CERRAR SESIÓN</button>
            </div>
        </div>

        <div class="w-3/4 bg-[#f4f6f9] h-full flex flex-col relative">
            <div v-if="selected" class="flex-1 overflow-y-auto p-8 pb-24">
                <div class="max-w-5xl mx-auto bg-white rounded-2xl shadow-sm border overflow-hidden">
                    <div class="p-6 border-b flex justify-between items-center sticky top-0 z-30 bg-white/95 backdrop-blur">
                        <div class="flex items-center gap-4">
                            <h2 class="text-2xl font-extrabold" :class="form.baja ? 'text-gray-400' : 'text-[#243c7a]'">
                                {{ isNew ? 'Nuevo Alumno' : form.nombre + ' ' + form.apellidos }}
                            </h2>
                            <span v-if="form.baja" class="bg-red-100 text-red-600 px-3 py-1 rounded-full text-xs font-bold">INACTIVO</span>
                        </div>
                        <div class="flex items-center gap-3">
                             <div class="flex items-center gap-2 mr-4 bg-gray-100 p-1.5 rounded-lg select-none">
                                <span class="text-[10px] font-bold uppercase" :class="!form.baja ? 'text-green-600' : 'text-gray-400'">Alta</span>
                                <button @click="form.baja = !form.baja" class="relative w-10 h-5 rounded-full transition-colors focus:outline-none" :class="form.baja ? 'bg-gray-400' : 'bg-[#25D366]'">
                                    <div class="absolute top-1 left-1 bg-white w-3 h-3 rounded-full shadow transition-transform" :class="form.baja ? 'translate-x-5' : 'translate-x-0'"></div>
                                </button>
                                <span class="text-[10px] font-bold uppercase" :class="form.baja ? 'text-red-500' : 'text-gray-400'">Baja</span>
                            </div>
                            <button @click="selected = null" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg font-semibold">Cancelar</button>
                            <button @click="saveData" :disabled="saving" class="bg-[#25D366] text-white px-6 py-2 rounded-lg hover:bg-[#1faa50] font-bold shadow-lg flex items-center gap-2">
                                <i v-if="saving" class="fas fa-spinner fa-spin"></i>
                                <i v-else class="fas fa-save"></i>
                                {{ saving ? 'Guardando...' : 'Guardar' }}
                            </button>
                        </div>
                    </div>

                    <form class="p-8 space-y-8" :class="form.baja ? 'opacity-70 grayscale-[0.5]' : ''">
                        <section class="grid grid-cols-4 gap-6">
                            <div class="col-span-4 font-bold text-[#243c7a] border-b pb-2">DATOS PERSONALES</div>
                            <input v-model="form.nombre" placeholder="Nombre" class="p-3 rounded-lg border bg-gray-50 focus:bg-white outline-none">
                            <input v-model="form.apellidos" placeholder="Apellidos" class="p-3 rounded-lg border bg-gray-50 focus:bg-white outline-none">
                            <input v-model="form.dni" placeholder="DNI/NIE" class="p-3 rounded-lg border bg-gray-50 focus:bg-white outline-none">
                            <input type="date" v-model="form.nacimiento" class="p-3 rounded-lg border bg-gray-50 focus:bg-white outline-none">
                        </section>
                        <section class="grid grid-cols-6 gap-6">
                            <div class="col-span-6 font-bold text-[#243c7a] border-b pb-2">DIRECCIÓN</div>
                            <input v-model="form.direccion" placeholder="Domicilio" class="col-span-3 p-3 rounded-lg border bg-gray-50 outline-none">
                            <input v-model="form.cp" placeholder="CP" class="p-3 rounded-lg border bg-gray-50 outline-none">
                            <input v-model="form.poblacion" placeholder="Población" class="p-3 rounded-lg border bg-gray-50 outline-none">
                            <input v-model="form.provincia" placeholder="Provincia" class="p-3 rounded-lg border bg-gray-50 outline-none">
                        </section>
                        <section class="grid grid-cols-3 gap-6">
                            <div class="col-span-3 font-bold text-[#243c7a] border-b pb-2">ACADÉMICO</div>
                            <input v-model="form.colegio" placeholder="Colegio" class="p-3 rounded-lg border bg-gray-50 outline-none">
                            <input v-model="form.curso" placeholder="Curso" class="p-3 rounded-lg border bg-gray-50 outline-none">
                            <input v-model="form.tlf" placeholder="Teléfono Alumno" class="p-3 rounded-lg border bg-gray-50 outline-none">
                        </section>
                        <section class="grid grid-cols-2 gap-8">
                            <div class="bg-green-50 p-6 rounded-2xl border border-green-200">
                                <div class="font-bold text-green-800 mb-4">FAMILIAR 1</div>
                                <div class="space-y-3">
                                    <input v-model="form.fam1_nombre" placeholder="Nombre Completo" class="w-full p-2 border rounded bg-white">
                                    <select v-model="form.fam1_relacion" class="w-full p-2 border rounded bg-white"><option value="" disabled>Relación...</option><option>Mamá</option><option>Papá</option><option>Tutor</option><option>Otro</option></select>
                                    <div class="flex gap-2">
                                        <input v-model="form.fam1_tlf" placeholder="Teléfono" class="w-full p-2 border rounded">
                                        <a v-if="form.fam1_tlf" :href="'https://wa.me/34'+String(form.fam1_tlf).replace(/\s/g,'')" target="_blank" class="bg-[#25D366] text-white px-3 rounded flex items-center hover:bg-green-600"><i class="fab fa-whatsapp"></i></a>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-gray-100 p-6 rounded-2xl border border-gray-200">
                                <div class="font-bold text-gray-600 mb-4">FAMILIAR 2</div>
                                <div class="space-y-3">
                                    <input v-model="form.fam2_nombre" placeholder="Nombre Completo" class="w-full p-2 border rounded bg-white">
                                    <select v-model="form.fam2_relacion" class="w-full p-2 border rounded bg-white"><option value="" disabled>Relación...</option><option>Mamá</option><option>Papá</option><option>Tutor</option><option>Otro</option></select>
                                    <div class="flex gap-2">
                                        <input v-model="form.fam2_tlf" placeholder="Teléfono" class="w-full p-2 border rounded">
                                        <a v-if="form.fam2_tlf" :href="'https://wa.me/34'+String(form.fam2_tlf).replace(/\s/g,'')" target="_blank" class="bg-gray-400 text-white px-3 rounded flex items-center hover:bg-gray-500"><i class="fab fa-whatsapp"></i></a>
                                    </div>
                                </div>
                            </div>
                        </section>
                    </form>
                </div>
            </div>
            <div v-else class="h-full flex flex-col items-center justify-center text-gray-400 select-none">
                <div class="bg-white p-10 rounded-full shadow-lg mb-6 animate-pulse">
                    <i class="fas fa-folder-open text-6xl text-[#2b94cc] opacity-50"></i>
                </div>
                <h2 class="text-xl font-bold text-[#243c7a]">Selecciona un alumno</h2>
            </div>
        </div>
    </div>
</div>

<script>
    const { createApp } = Vue;
    // CONFIGURACIÓN
    const PASS_HASH = "MDEwNTIz"; 
    // Asegúrate de que esta URL corresponde a tu NUEVA implementación
    const ENCRYPTED_URL = "aHR0cHM6Ly9zY3JpcHQuZ29vZ2xlLmNvbS9tYWNyb3Mvcy9BS2Z5Y2J6T3hlWmIzTVotY21WZG5GMjBERmtXN0Vrem9aeXVLNlp3bExpSmltbWdsYjVpTXJDV3NCQWdGYndXTXJGN25ja3kvZXhlYw==";

    createApp({
        data() {
            return {
                authenticated: false, passwordInput: '', loginError: false, apiUrl: '', 
                list: [], search: '', selected: null, isNew: false, loading: false, saving: false,
                showSuccess: false, successMessage: '', form: {}, showInactive: false
            }
        },
        computed: {
            filteredList() {
                // ARREGLO 2: Si no hay búsqueda, devuelve todo (respeta el filtro de bajas)
                if (!this.search) {
                     return this.list.filter(s => this.showInactive ? true : !s.baja);
                }
                const t = this.search.toLowerCase();
                return this.list.filter(s => {
                    const matchText = (s.nombre?.toLowerCase().includes(t)) || (s.apellidos?.toLowerCase().includes(t)) || (s.dni?.includes(t));
                    const matchState = this.showInactive ? true : !s.baja;
                    return matchText && matchState;
                });
            }
        },
        methods: {
            login() {
                if (btoa(this.passwordInput) === PASS_HASH) {
                    this.authenticated = true;
                    this.loginError = false;
                } else { this.loginError = true; this.passwordInput = ''; }
            },
            logout() { location.reload(); },
            async loadData() {
                this.loading = true;
                try {
                    this.apiUrl = atob(ENCRYPTED_URL);
                    const res = await fetch(this.apiUrl);
                    const json = await res.json();
                    if (json.status === 'success') {
                        this.list = json.data.sort((a, b) => (a.apellidos || "").localeCompare(b.apellidos || ""));
                    }
                } catch (e) { console.error(e); }
                this.loading = false;
            },
            createNew() {
                this.isNew = true;
                this.form = { nombre:'', apellidos:'', dni:'', nacimiento:'', direccion:'', cp:'', poblacion:'', provincia:'', colegio:'', curso:'', tlf:'', fam1_nombre:'', fam1_relacion:'', fam1_tlf:'', fam2_nombre:'', fam2_relacion:'', fam2_tlf:'', baja: false };
                this.selected = { id: 'TEMP' };
            },
            selectStudent(s) {
                try {
                    let tempForm = JSON.parse(JSON.stringify(s));
                    this.form = tempForm;
                    this.isNew = false;
                    this.selected = s;

                    // ARREGLO 1: Forzamos que los teléfonos sean texto al abrir la ficha
                    // para que el HTML no se rompa al intentar leerlos
                    this.form.fam1_tlf = String(this.form.fam1_tlf || '');
                    this.form.fam2_tlf = String(this.form.fam2_tlf || '');
                    this.form.tlf = String(this.form.tlf || '');

                    // Limpieza segura de fecha
                    try {
                        let val = tempForm.nacimiento;
                        let cleanDate = '';
                        if (val && typeof val === 'string') {
                            val = val.trim();
                            if (val.includes('/')) {
                                const p = val.split('/');
                                if (p.length === 3) cleanDate = `${p[2]}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}`;
                            } else if (val.includes('T')) cleanDate = val.split('T')[0];
                            else if (val.includes('-')) cleanDate = val;
                        }
                        this.form.nacimiento = cleanDate;
                    } catch(errDate) { this.form.nacimiento = ''; }

                } catch(e) { console.error("Error abriendo ficha", e); }
            },
            async saveData() {
                this.saving = true;
                try {
                    await fetch(this.apiUrl, { method: 'POST', body: JSON.stringify({ ...this.form, action: this.isNew ? 'create' : 'update', id: this.selected.id }) });
                    this.showSuccess = true;
                    this.successMessage = this.isNew ? 'Creado correctamente' : 'Actualizado correctamente';
                    this.loadData();
                    setTimeout(() => { this.showSuccess = false; this.selected = null; this.saving = false; }, 2000);
                } catch (e) { alert('Error de conexión'); this.saving = false; }
            }
        },
        mounted() { this.loadData(); }
    }).mount('#app');
</script>
</body>
</html>
