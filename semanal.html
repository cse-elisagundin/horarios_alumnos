<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Horario Semanal CSE</title>
    <link rel="icon" type="image/png" href="https://github.com/cse-elisagundin/horarios_alumnos/blob/main/image.png?raw=true">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        /* AQU√ç VAN TUS ESTILOS ORIGINALES COMPLETOS (Omitidos por espacio pero mantenlos todos) */
        :root { --c-primary: #243c7a; --c-secondary: #2b94cc; --c-accent: #fa65c3; --bg-body: #f4f6f9; --bg-container: #ffffff; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg-body); margin: 0; padding: 15px; }
        .container { width: 95%; max-width: 1600px; margin: 0 auto; background: white; padding: 20px; border-radius: 20px; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th, td { border: 1px solid #eee; padding: 4px; text-align: center; font-size: 11.5px; }
        th { background: var(--c-primary); color: white; }
        .col-hora { width: 50px; font-weight: 800; color: var(--c-primary); }
        .name-tag { font-weight: 900; text-transform: uppercase; }
        @media print { body { zoom: 65%; } .no-print-dynamic { display: none; } }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="header-left">
            <button class="btn-action btn-print" onclick="window.print()">üñ®Ô∏è Imprimir</button>
        </div>
        <div class="live-info-panel no-print-dynamic">
            <div id="digital-clock" class="digital-clock">00:00:00</div>
        </div>
    </header>
    <div class="days-nav" id="days-buttons"></div>
    <div id="loading" class="spinner"></div>
    <div id="schedule-container"></div>
</div>

<script>
    const URL_MODIFICACIONES = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTa_AjdQ-TzUs68ciZCnbgsUzqRF78m8e-oMrmbrorAsXjaFckYe6JQAzyKFlY6jcvWTMVZ3UDcqxMx/pub?output=csv";
    const urls = {
        "Lunes": "https://docs.google.com/spreadsheets/d/e/2PACX-1vTa_AjdQ-TzUs68ciZCnbgsUzqRF78m8e-oMrmbrorAsXjaFckYe6JQAzyKFlY6jcvWTMVZ3UDcqxMx/pub?gid=0&single=true&output=csv",
        "Martes": "https://docs.google.com/spreadsheets/d/e/2PACX-1vTa_AjdQ-TzUs68ciZCnbgsUzqRF78m8e-oMrmbrorAsXjaFckYe6JQAzyKFlY6jcvWTMVZ3UDcqxMx/pub?gid=1905233272&single=true&output=csv",
        "Mi√©rcoles": "https://docs.google.com/spreadsheets/d/e/2PACX-1vTa_AjdQ-TzUs68ciZCnbgsUzqRF78m8e-oMrmbrorAsXjaFckYe6JQAzyKFlY6jcvWTMVZ3UDcqxMx/pub?gid=745373517&single=true&output=csv",
        "Jueves": "https://docs.google.com/spreadsheets/d/e/2PACX-1vTa_AjdQ-TzUs68ciZCnbgsUzqRF78m8e-oMrmbrorAsXjaFckYe6JQAzyKFlY6jcvWTMVZ3UDcqxMx/pub?gid=314818236&single=true&output=csv",
        "Viernes": "https://docs.google.com/spreadsheets/d/e/2PACX-1vTa_AjdQ-TzUs68ciZCnbgsUzqRF78m8e-oMrmbrorAsXjaFckYe6JQAzyKFlY6jcvWTMVZ3UDcqxMx/pub?gid=1396865785&single=true&output=csv"
    };

    function getWeekNumber(d) {
        d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
        var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
        return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
    }

    function leerHoja(url) {
        return new Promise(resolve => {
            Papa.parse(url + "&t=" + Date.now(), { download: true, skipEmptyLines: true, complete: res => resolve(res.data), error: () => resolve([]) });
        });
    }

    async function cargarTodo() {
        const container = document.getElementById('schedule-container');
        const dias = Object.keys(urls);
        const [results, mods] = await Promise.all([Promise.all(dias.map(d => leerHoja(urls[d]))), leerHoja(URL_MODIFICACIONES)]);
        
        const isSemanaPar = getWeekNumber(new Date()) % 2 === 0;
        container.innerHTML = "";

        dias.forEach((dia, idx) => {
            let data = JSON.parse(JSON.stringify(results[idx]));
            if(!data.length) return;

            // 1. Filtro A/B
            for(let r=1; r<data.length; r++){
                for(let c=1; c<=13; c++){
                    if(c===7) continue;
                    let v = (data[r][c] || "").trim();
                    if((v.includes("[A]") && isSemanaPar) || (v.includes("[B]") && !isSemanaPar)) data[r][c] = "";
                    data[r][c] = (data[r][c] || "").replace(/\[A\]|\[B\]/g, "").trim();
                }
            }

            // 2. Aplicar Modificaciones
            if(mods) mods.forEach((m, i) => {
                if(i===0 || (m[0]||"").trim().toLowerCase() !== dia.toLowerCase()) return;
                let startR = data.findIndex(row => (row[0]||"") === m[1] || (row[7]||"") === m[1]);
                let blocks = Math.ceil(parseFloat((m[2]||"0").replace("h",""))/0.5);
                if(startR === -1) return;
                for(let b=0; b<blocks; b++){
                    let r = startR + b; if(r >= data.length) break;
                    let range = (m[3]||"").toLowerCase().includes("ing") ? [8,13] : [1,6];
                    if(m[4]==="QUITAR"){
                        for(let c=range[0]; c<=range[1]; c++) if(data[r][c].toLowerCase().includes(m[6].toLowerCase())) data[r][c] = "";
                    } else if(m[4]==="A√ëADIR"){
                        for(let c=range[0]; c<=range[1]; c++) if(!data[r][c].trim()){
                            let tag = m[5] ? ` [${m[5].substring(0,3).toUpperCase()}]` : " [EXT]";
                            data[r][c] = m[6] + tag; break;
                        }
                    }
                }
            });

            // 3. Renderizar Tabla (Tu estructura original)
            let h = data[0];
            let html = `<div id="view-${dia}" class="planning-container visible">
                <h2>${dia.toUpperCase()}</h2>
                <div class="tables-wrapper">
                    <div class="table-block"><table><thead><tr><th>${h[0]}</th>${h.slice(1,7).map(x=>`<th>${x}</th>`).join('')}</tr></thead><tbody>`;
            let ing = "";
            for(let i=1; i<data.length; i++){
                const r = data[i];
                html += `<tr><td class="col-hora">${r[0]}</td>${r.slice(1,7).map(c=>`<td><span class="name-tag">${c}</span></td>`).join('')}</tr>`;
                ing += `<tr><td class="col-hora">${r[7]}</td>${r.slice(8,14).map(c=>`<td><span class="name-tag">${c}</span></td>`).join('')}</tr>`;
            }
            html += `</tbody></table></div><div class="table-block"><table><thead><tr><th>${h[7]}</th>${h.slice(8,14).map(x=>`<th>${x}</th>`).join('')}</tr></thead><tbody>${ing}</tbody></table></div></div></div>`;
            container.innerHTML += html;
        });
        document.getElementById('loading').style.display='none';
    }

    document.addEventListener('DOMContentLoaded', cargarTodo);
    setInterval(() => { document.getElementById('digital-clock').innerText = new Date().toLocaleTimeString(); }, 1000);
</script>
</body>
</html>
