<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda Profesor - Proxy</title>
    <link rel="icon" type="image/png" href="https://github.com/cse-elisagundin/horarios_alumnos/blob/main/image.png?raw=true">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <style>
        :root { --primary: #003366; --bg: #f4f7f9; --light: #ffffff; }
        
        body { 
            font-family: 'Segoe UI', Tahoma, sans-serif; 
            background-color: var(--bg); 
            margin: 0; padding: 20px; color: #333;
        }

        .container { max-width: 800px; margin: 0 auto; background: var(--light); padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }

        /* HEADER */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        h1 { color: var(--primary); margin: 0; font-size: 22px; }
        .btn-print { background: #555; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; }
        .btn-print:hover { background: #333; }

        /* BOTONERA */
        .nav-days { display: flex; gap: 8px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
        .btn-day {
            flex: 1; padding: 10px; border: 1px solid #ddd; background: white; 
            border-radius: 6px; cursor: pointer; font-weight: 600; color: #555; white-space: nowrap;
        }
        .btn-day.active { background: var(--primary); color: white; border-color: var(--primary); transform: translateY(-2px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* VISTA D√çA */
        .day-content { display: none; animation: fade 0.3s; }
        .day-content.active { display: block; }
        @keyframes fade { from { opacity: 0; } to { opacity: 1; } }

        /* FILA DE HORARIO */
        .time-row { display: flex; border-bottom: 1px solid #f0f0f0; padding: 10px 0; align-items: flex-start; }
        .time-row:hover { background: #fcfcfc; }
        
        .col-hora { 
            width: 70px; font-weight: bold; color: var(--primary); font-size: 15px; 
            padding-top: 5px; border-right: 3px solid #eee; margin-right: 15px; text-align: center;
        }
        
        .col-alumnos { flex: 1; display: flex; flex-wrap: wrap; gap: 8px; }
        
        .tag-alumno {
            background: #eef4ff; color: var(--primary); padding: 5px 12px; border-radius: 20px;
            font-size: 14px; border: 1px solid #dce8f7; display: flex; align-items: center;
        }

        /* LOG DE DEBUG (Para ver errores) */
        #debug { 
            margin-top: 30px; padding: 10px; background: #333; color: #0f0; 
            font-family: monospace; font-size: 11px; max-height: 150px; overflow-y: auto; border-radius: 6px;
            display: none; /* Oculto por defecto, se activa si hay error */
        }
        .error-txt { color: #ff5555; }

        /* IMPRESI√ìN */
        @media print {
            body { background: white; padding: 0; }
            .container { box-shadow: none; max-width: 100%; margin: 0; padding: 0; }
            .nav-days, .btn-print, #debug { display: none; }
            .day-content { display: block !important; break-inside: avoid; margin-bottom: 30px; }
            .day-title { display: block; font-size: 20px; font-weight: bold; border-bottom: 2px solid black; margin-bottom: 10px; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Agenda Diaria</h1>
        <button class="btn-print" onclick="window.print()">üñ®Ô∏è Imprimir</button>
    </header>

    <div id="nav" class="nav-days"></div>
    <div id="content">
        <p style="text-align:center; color:#666">Cargando datos...</p>
    </div>

    <div id="debug">LOG DEL SISTEMA:<br></div>
</div>

<script>
    // 1. DEFINIMOS LAS URLs (Forzamos output=csv en todas para evitar errores de formato)
    const baseID = "2PACX-1vTa_AjdQ-TzUs68ciZCnbgsUzqRF78m8e-oMrmbrorAsXjaFckYe6JQAzyKFlY6jcvWTMVZ3UDcqxMx";
    const diasConfig = [
        { nombre: "Lunes",     gid: "0" },
        { nombre: "Martes",    gid: "1905233272" },
        { nombre: "Mi√©rcoles", gid: "745373517" },
        { nombre: "Jueves",    gid: "314818236" },
        { nombre: "Viernes",   gid: "1396865785" }
    ];

    function log(msg, esError = false) {
        const d = document.getElementById('debug');
        if(esError) {
            d.style.display = 'block'; // Mostrar consola si hay error
            d.innerHTML += `<span class="error-txt">[ERROR] ${msg}</span><br>`;
        } else {
            d.innerHTML += `<span>[INFO] ${msg}</span><br>`;
        }
    }

    // 2. FUNCI√ìN DE CARGA BLINDADA (Usa Proxy AllOrigins)
    async function cargarDia(diaObj) {
        // Construimos la URL oficial de Google CSV
        const googleUrl = `https://docs.google.com/spreadsheets/d/e/${baseID}/pub?gid=${diaObj.gid}&single=true&output=csv`;
        
        // Pasamos esa URL por el Proxy para evitar bloqueo CORS
        // A√±adimos timestamp para evitar cach√© vieja
        const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(googleUrl)}&t=${Date.now()}`;

        try {
            log(`Solicitando ${diaObj.nombre}...`);
            const response = await fetch(proxyUrl);
            
            if (!response.ok) throw new Error("Error de red: " + response.status);
            
            const textoCSV = await response.text();
            
            // Verificamos si Google nos devolvi√≥ un HTML de error en vez de CSV
            if(textoCSV.trim().startsWith("<!DOCTYPE")) {
                throw new Error("Google devolvi√≥ una p√°gina de error (posiblemente ID incorrecto)");
            }

            // Parseamos
            const resultado = Papa.parse(textoCSV, { header: false, skipEmptyLines: true });
            
            if (resultado.errors.length > 0) {
                log(`Error parseando ${diaObj.nombre}: ${JSON.stringify(resultado.errors)}`, true);
                return null;
            }

            log(`${diaObj.nombre} cargado: ${resultado.data.length} filas.`);
            return { nombre: diaObj.nombre, data: resultado.data };

        } catch (error) {
            log(`Fallo al cargar ${diaObj.nombre}: ${error.message}`, true);
            return null;
        }
    }

    async function iniciar() {
        const nav = document.getElementById('nav');
        const content = document.getElementById('content');
        
        // Generar botones
        let botonesHTML = "";
        diasConfig.forEach(d => {
            botonesHTML += `<button class="btn-day" id="btn-${d.nombre}" onclick="verDia('${d.nombre}')">${d.nombre}</button>`;
        });
        nav.innerHTML = botonesHTML;

        // Cargar datos
        const promesas = diasConfig.map(d => cargarDia(d));
        const resultados = await Promise.all(promesas);

        content.innerHTML = ""; // Limpiar mensaje de carga

        resultados.forEach(res => {
            if(!res) {
                // Si fall√≥ la carga de este d√≠a
                return; 
            }

            const nombre = res.nombre;
            const filas = res.data;
            let hayClases = false;
            let htmlFilas = "";

            // Saltamos la fila 0 (cabeceras)
            for(let i=1; i<filas.length; i++) {
                const fila = filas[i];
                // Asumimos Col 1 = Hora, Col 2+ = Alumnos
                let hora = fila[1] ? fila[1].trim() : "";
                
                // Limpiar hora (16:00:00 -> 16:00)
                if(hora.length > 5) hora = hora.substring(0, 5);

                let alumnos = [];
                for(let c=2; c<fila.length; c++) {
                    if(fila[c] && fila[c].trim()) alumnos.push(fila[c].trim());
                }

                if(hora && alumnos.length > 0) {
                    hayClases = true;
                    htmlFilas += `
                        <div class="time-row">
                            <div class="col-hora">${hora}</div>
                            <div class="col-alumnos">
                                ${alumnos.map(al => `<span class="tag-alumno">üë§ ${al}</span>`).join('')}
                            </div>
                        </div>
                    `;
                }
            }

            if(!hayClases) {
                htmlFilas = "<p style='padding:20px; color:#999; text-align:center'>No hay clases programadas.</p>";
            }

            // Crear contenedor del d√≠a
            const divDia = document.createElement('div');
            divDia.id = `view-${nombre}`;
            divDia.className = "day-content";
            divDia.innerHTML = `<div class="day-title" style="display:none">${nombre}</div>` + htmlFilas;
            content.appendChild(divDia);
        });

        // Activar d√≠a actual o Lunes por defecto
        const map = ["Domingo", "Lunes", "Martes", "Mi√©rcoles", "Jueves", "Viernes", "S√°bado"];
        let hoy = map[new Date().getDay()];
        let diaInicial = diasConfig.find(d => d.nombre === hoy) ? hoy : "Lunes";
        
        verDia(diaInicial);
    }

    // Funci√≥n global para cambiar pesta√±a
    window.verDia = function(diaNombre) {
        // Botones
        document.querySelectorAll('.btn-day').forEach(b => {
            b.classList.remove('active');
            if(b.id === `btn-${diaNombre}`) b.classList.add('active');
        });
        // Vistas
        document.querySelectorAll('.day-content').forEach(v => {
            v.classList.remove('active');
            if(v.id === `view-${diaNombre}`) v.classList.add('active');
        });
    }

    // Arrancar
    document.addEventListener('DOMContentLoaded', iniciar);
</script>

</body>
</html>
