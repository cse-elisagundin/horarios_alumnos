<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda Profesor - Conexi√≥n R√°pida</title>
    <link rel="icon" type="image/png" href="https://github.com/cse-elisagundin/horarios_alumnos/blob/main/image.png?raw=true">

    <style>
        :root { --primary: #004488; --bg: #f5f7fa; --line: #e0e0e0; }
        
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #333; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }

        /* HEADER */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid var(--line); padding-bottom: 20px; }
        h1 { margin: 0; color: var(--primary); font-size: 24px; }
        button.print-btn { background: #445566; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        button.print-btn:hover { background: #333; }

        /* BOTONES D√çAS */
        .nav { display: flex; gap: 10px; margin-bottom: 30px; overflow-x: auto; padding-bottom: 5px; }
        .nav button {
            flex: 1; padding: 10px; border: 1px solid var(--line); background: white; border-radius: 8px;
            cursor: pointer; font-weight: 600; color: #666; transition: all 0.2s; white-space: nowrap;
        }
        .nav button.active { background: var(--primary); color: white; border-color: var(--primary); transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,68,136,0.2); }

        /* TIMELINE (AGENDA) */
        .day-view { display: none; animation: fadeIn 0.3s; }
        .day-view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .time-row { display: flex; border-bottom: 1px solid #f0f0f0; padding: 12px 0; align-items: flex-start; }
        .time-row:last-child { border-bottom: none; }
        .time-row:hover { background-color: #fafbfc; }

        .hour-col {
            width: 70px; font-weight: 800; color: var(--primary); font-size: 15px;
            padding-top: 6px; text-align: center; border-right: 3px solid #eee; margin-right: 15px;
        }

        .students-col { flex: 1; display: flex; flex-wrap: wrap; gap: 8px; }

        .student-tag {
            background: #eef4ff; color: #004488; padding: 6px 12px; border-radius: 6px;
            font-size: 14px; font-weight: 500; border-left: 4px solid var(--primary);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); display: flex; align-items: center;
        }

        /* ESTADO Y ERRORES */
        .msg { text-align: center; padding: 20px; color: #666; }
        .error { color: #d32f2f; background: #ffebee; padding: 15px; border-radius: 8px; }

        /* IMPRESI√ìN */
        @media print {
            body { background: white; padding: 0; }
            .container { box-shadow: none; max-width: 100%; padding: 0; }
            .nav, .print-btn { display: none; }
            .day-view { display: block !important; margin-bottom: 30px; page-break-inside: avoid; }
            .day-title { display: block; font-size: 20px; font-weight: bold; margin-bottom: 10px; border-bottom: 2px solid black; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div>
            <h1>Agenda de Clases</h1>
            <small style="color:#666">Vista Cronol√≥gica</small>
        </div>
        <button class="print-btn" onclick="window.print()">üñ®Ô∏è Imprimir</button>
    </header>

    <div class="nav" id="nav-buttons"></div>
    <div id="content-area">
        <div class="msg" id="loading-msg">Conectando con Google...</div>
    </div>
</div>

<script>
    // TUS DATOS: Solo necesitamos el ID de la hoja y el GID de cada pesta√±a
    // La URL base es siempre la misma, solo cambia el ID
    const SHEET_ID = "2PACX-1vTa_AjdQ-TzUs68ciZCnbgsUzqRF78m8e-oMrmbrorAsXjaFckYe6JQAzyKFlY6jcvWTMVZ3UDcqxMx";
    
    // Mapeo de D√≠as con sus GIDs (sacados de tus enlaces anteriores)
    const DIAS = [
        { nombre: "Lunes",     gid: "0" },
        { nombre: "Martes",    gid: "1905233272" },
        { nombre: "Mi√©rcoles", gid: "745373517" },
        { nombre: "Jueves",    gid: "314818236" },
        { nombre: "Viernes",   gid: "1396865785" }
    ];

    // Funci√≥n m√°gica: Usa 'gviz/tq' que devuelve JSON y no da error de CORS
    async function fetchData(gid) {
        const url = `https://docs.google.com/spreadsheets/d/e/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${gid}`;
        
        try {
            const res = await fetch(url);
            const text = await res.text();
            // Google devuelve algo como: /*O_o*/ google.visualization.Query.setResponse({...})
            // Limpiamos el texto para sacar solo el JSON
            const jsonText = text.substring(47, text.length - 2);
            const json = JSON.parse(jsonText);
            return json.table;
        } catch (e) {
            console.error("Error cargando GID " + gid, e);
            return null;
        }
    }

    async function init() {
        const nav = document.getElementById('nav-buttons');
        const content = document.getElementById('content-area');
        
        // 1. Generar Botones
        DIAS.forEach(d => {
            const btn = document.createElement('button');
            btn.innerText = d.nombre;
            btn.onclick = () => switchTab(d.nombre);
            btn.id = `btn-${d.nombre}`;
            nav.appendChild(btn);
        });

        // 2. Cargar datos en paralelo
        const promises = DIAS.map(d => fetchData(d.gid));
        const results = await Promise.all(promises);
        
        document.getElementById('loading-msg').style.display = 'none';

        // 3. Renderizar cada d√≠a
        results.forEach((table, index) => {
            const diaNombre = DIAS[index].nombre;
            
            if (!table || !table.rows) {
                const err = document.createElement('div');
                err.className = `day-view`;
                err.id = `view-${diaNombre}`;
                err.innerHTML = `<div class="error">No se pudieron cargar datos para el ${diaNombre}</div>`;
                content.appendChild(err);
                return;
            }

            const wrapper = document.createElement('div');
            wrapper.className = 'day-view';
            wrapper.id = `view-${diaNombre}`;
            
            // T√≠tulo para imprimir
            wrapper.innerHTML = `<div class="day-title" style="display:none">${diaNombre}</div>`;

            let rowsHTML = "";
            let hayClases = false;

            // Procesar filas de Google Viz
            // Google Viz rows: C array. C[0] es col A, C[1] es col B (Hora), C[2...] alumnos
            table.rows.forEach(row => {
                const cols = row.c;
                if (!cols || !cols[1]) return; // Si no hay hora, saltar

                // Formatear hora (a veces viene como objeto, a veces string)
                let hora = cols[1].v; 
                if(!hora) return;
                // Si es string "16:00:00", cortar. Si es objeto fecha, formatear.
                if(typeof hora === 'string') hora = hora.substring(0, 5);

                // Buscar alumnos (desde columna 2 en adelante)
                let alumnos = [];
                for (let i = 2; i < cols.length; i++) {
                    if (cols[i] && cols[i].v) {
                        alumnos.push(cols[i].v);
                    }
                }

                if (alumnos.length > 0) {
                    hayClases = true;
                    rowsHTML += `
                        <div class="time-row">
                            <div class="hour-col">${hora}</div>
                            <div class="students-col">
                                ${alumnos.map(al => `<div class="student-tag">üë§ ${al}</div>`).join('')}
                            </div>
                        </div>
                    `;
                }
            });

            if (!hayClases) rowsHTML = `<div class="msg">No hay clases programadas.</div>`;
            
            wrapper.innerHTML += rowsHTML;
            content.appendChild(wrapper);
        });

        // 4. Seleccionar d√≠a actual
        const hoyIndex = new Date().getDay(); // 0 Dom, 1 Lun...
        // Mapear js day (0-6) a nuestros dias. Si es finde -> Lunes
        const map = ["Domingo", "Lunes", "Martes", "Mi√©rcoles", "Jueves", "Viernes", "S√°bado"];
        let hoyNombre = map[hoyIndex];
        const existe = DIAS.find(d => d.nombre === hoyNombre);
        switchTab(existe ? hoyNombre : "Lunes");
    }

    function switchTab(dia) {
        // Botones
        document.querySelectorAll('.nav button').forEach(b => {
            b.classList.remove('active');
            if(b.id === `btn-${dia}`) b.classList.add('active');
        });
        // Vistas
        document.querySelectorAll('.day-view').forEach(v => {
            v.classList.remove('active');
            if(v.id === `view-${dia}`) v.classList.add('active');
        });
    }

    init();
</script>

</body>
</html>
