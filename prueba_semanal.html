<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Horario Maestro Interactivo CSE</title>
    
    <link rel="icon" type="image/png" href="https://github.com/cse-elisagundin/horarios_alumnos/blob/main/image.png?raw=true">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <style>
        /* =========================================================================
           CSS ORIGINAL DE SEMANAL.HTML (PANTALLA)
           ========================================================================= */
        :root { 
            --c-primary: #243c7a; --c-secondary: #2b94cc; --c-accent: #fa65c3;      
            --bg-body: #f4f6f9; --bg-container: #ffffff;
        }
        
        body { font-family: 'Segoe UI', Roboto, sans-serif; background-color: var(--bg-body); margin: 0; padding: 15px; color: #333; }
        .container { width: 95%; max-width: 1600px; margin: 0 auto; background: var(--bg-container); padding: 20px; border-radius: 20px; box-shadow: 0 10px 30px rgba(36, 60, 122, 0.08); border: 4px solid #ff9800; }

        /* BRANDING */
        .web-brand { text-align: center; margin-bottom: 20px; }
        .web-logo-img { height: 70px; object-fit: contain; }
        .brand-line { height: 5px; width: 80px; margin: 10px auto 0; background: linear-gradient(90deg, var(--c-primary), var(--c-secondary), var(--c-accent)); border-radius: 10px; }

        /* HEADER Y RELOJ */
        header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; gap: 15px; flex-wrap: wrap; }
        .digital-clock { font-size: 24px; font-weight: 800; color: var(--c-primary); }
        .btn-action { padding: 10px 20px; border-radius: 50px; cursor: pointer; font-weight: 700; font-size: 14px; display: inline-flex; align-items: center; gap: 8px; text-decoration: none; text-transform: uppercase; border: none; }
        .btn-print { background-color: var(--c-primary); color: white; }

        /* TABLAS Y CELDAS */
        .planning-container { display: none; }
        .planning-container.visible { display: block; }
        .tables-wrapper { display: flex; gap: 20px; }
        .table-block { flex: 1; background: white; border-radius: 16px; overflow: hidden; border: 1px solid #dce1e6; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th, td { border-bottom: 1px solid #eee; border-right: 1px solid #eee; padding: 4px; text-align: center; font-size: 11.5px; height: 42px; position: relative; }
        th { background: var(--c-primary); color: white; text-transform: uppercase; }
        .col-hora { width: 45px; background: white !important; font-weight: 800; color: var(--c-primary) !important; }

        /* ETIQUETAS Y HOVER */
        .name-tag { display: inline-block; padding: 4px 10px; border-radius: 12px; font-weight: 900; text-transform: uppercase; color: var(--c-primary); background: #f0f4f8; }
        td.slot:hover { background-color: #fff9c4 !important; cursor: pointer; }
        td.slot:hover::after { content: '‚úé'; position: absolute; right: 2px; top: 2px; font-size: 10px; color: #ff9800; }

        /* EDITOR FLOTANTE */
        #quick-editor {
            display: none; position: fixed; z-index: 10000; background: white;
            padding: 15px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            border: 2px solid var(--c-primary); width: 240px;
        }
        .ed-input { width: 100%; margin-bottom: 10px; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 13px; box-sizing: border-box; }
        .ed-btn { width: 100%; padding: 10px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; margin-top: 5px; }

        /* NAVEGACI√ìN */
        .days-nav { display: flex; gap: 5px; margin-bottom: 20px; justify-content: center; }
        .nav-btn { padding: 8px 14px; border: 1px solid #eee; background: white; border-radius: 10px; cursor: pointer; font-weight: 600; }
        .nav-btn.active { background: var(--c-primary); color: white; }

        .print-only-notes { display: none; }

        /* =========================================================================
           üñ®Ô∏è IMPRESI√ìN RIGUROSA (BASADA EN TUS IM√ÅGENES)
           ========================================================================= */
        @media print {
            @page { size: A4 landscape; margin: 5mm; }
            
            body { 
                background: white !important; 
                margin: 0; padding: 0; 
                display: grid !important; 
                grid-template-columns: 58% 40% !important; 
                column-gap: 15px;
                zoom: 65%;
            }

            /* Ocultamos todo lo de la web */
            .web-brand, header, .days-nav, #quick-editor, .nav-btn, .test-badge { display: none !important; }

            .container { 
                grid-column: 1; 
                width: 100% !important; 
                border: none !important; 
                box-shadow: none !important; 
                padding: 0 !important; 
                margin: 0 !important;
                display: block !important;
            }

            /* Solo mostramos el d√≠a activo */
            .planning-container { display: none !important; }
            .planning-container.visible { display: block !important; }

            .tables-wrapper { display: flex !important; flex-direction: column !important; gap: 10px !important; }
            .table-block { border: 1px solid #000 !important; border-radius: 0 !important; width: 100% !important; }

            /* Columna de NOTAS */
            .print-only-notes { 
                grid-column: 2; 
                display: block !important; 
                padding: 15px; 
                border-left: 2px solid #000 !important;
                background: white !important;
            }

            table { border: 1px solid #000 !important; width: 100% !important; }
            th, td { border: 1px solid #000 !important; color: black !important; font-size: 13px !important; height: auto !important; padding: 2px !important; }
            th { background: #eee !important; border-bottom: 2px solid #000 !important; }
            .col-hora { width: 50px !important; font-weight: bold !important; }
            .name-tag { background: none !important; color: black !important; font-weight: 900 !important; font-size: 15px !important; }

            .notes-header { display: flex; justify-content: space-between; border-bottom: 2px solid #000; margin-bottom: 10px; }
            .notes-title { font-size: 24px; font-weight: 900; margin: 0; }
            .day-title { font-size: 20px !important; color: black !important; }
        }
    </style>
</head>
<body>

<div id="quick-editor">
    <div id="ed-label" style="font-size: 10px; color: #999; margin-bottom: 8px; font-weight: bold;"></div>
    <input type="text" id="ed-val" class="ed-input" placeholder="Nombre alumno...">
    <select id="ed-dur" class="ed-input">
        <option value="30">30 min</option>
        <option value="60">1 hora</option>
        <option value="90">1,5 horas</option>
    </select>
    <button class="ed-btn" style="background:var(--c-primary); color:white;" onclick="aplicarExcepcion()">GUARDAR</button>
    <button class="ed-btn" style="background:#eee;" onclick="cerrarEditor()">CANCELAR</button>
</div>

<div class="container">
    <div class="web-brand">
        <img src="https://github.com/cse-elisagundin/horarios_alumnos/blob/main/image.png?raw=true" alt="Logo CSE" class="web-logo-img">
        <div class="brand-line"></div>
    </div>

    <header>
        <button class="btn-action btn-print" onclick="window.print()">üñ®Ô∏è Imprimir</button>
        <div id="digital-clock" class="digital-clock">00:00:00</div>
    </header>

    <div class="days-nav" id="days-buttons"></div>
    <div id="schedule-container"></div>
</div>

<div class="print-only-notes">
    <div class="notes-header">
        <h2 class="notes-title">NOTAS</h2>
        <img src="https://github.com/cse-elisagundin/horarios_alumnos/blob/main/image.png?raw=true" alt="Logo" style="height:40px;">
    </div>
    <div style="border-bottom: 1px solid #ccc; height: 30px; margin-bottom: 10px;" v-for="i in 20"></div>
    <script>
        for(let i=0; i<25; i++) document.write('<div style="border-bottom: 1px solid #eee; height: 30px;"></div>');
    </script>
</div>

<script>
    const APP_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwRRCZZZ7qfSApcoRxdVCH7pRrxYwi43pD8dv34TX8Edd22ZRZXkNIPZ-ytDEQreH8SOw/exec"; 
    const SHEET_ID = "1qx15eShPJdHaQt722I3sEUwWhL-0mcO56OMGVjm68bM"; 
    const GIDS = { "Lunes": "0", "Martes": "1905233272", "Mi√©rcoles": "745373517", "Jueves": "314818236", "Viernes": "1396865785" };
    const GID_HISTORIAL = "2008155671"; 

    let excepcionesHoy = [];
    let celdaActiva = null;

    async function cargarTodo() {
        const hoyFecha = new Date().toLocaleDateString('es-ES', {day:'2-digit', month:'2-digit', year:'numeric'});
        
        try {
            // 1. Cargar Historial
            const resH = await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID_HISTORIAL}&t=${Date.now()}`);
            const csvH = await resH.text();
            excepcionesHoy = Papa.parse(csvH).data.filter(f => f[0] === hoyFecha);

            // 2. Cargar Horarios
            const dias = Object.keys(GIDS);
            document.getElementById('days-buttons').innerHTML = dias.map(d => `<button class="nav-btn" id="btn-${d}" onclick="cambiarDia('${d}')">${d.toUpperCase()}</button>`).join('');

            const container = document.getElementById('schedule-container');
            container.innerHTML = "";

            for (const dia of dias) {
                const res = await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GIDS[dia]}&t=${Date.now()}`);
                const csv = await res.text();
                const dataM = Papa.parse(csv).data;

                let html = `<div id="view-${dia}" class="planning-container">
                    <div class="day-header"><h2 class="day-title">${dia.toUpperCase()}</h2></div>
                    <div class="tables-wrapper">
                        <div class="table-block"><table><thead><tr><th class="col-hora">H</th><th colspan="6">APOYO</th></tr></thead><tbody>`;
                
                let htmlIng = "";
                for (let i = 1; i < dataM.length; i++) {
                    const r = dataM[i]; if(!r[0]) continue;
                    
                    html += `<tr><td class="col-hora">${r[0]}</td>`;
                    for(let col=1; col<=6; col++) {
                        let v = buscarEx(dia, r[0], col, r[col]);
                        html += `<td class="slot student-cell" title="${v.toUpperCase()}" onclick="abrirEditor(this, '${dia}', '${r[0]}', ${col}, '${v}')"><span class="name-tag">${v.split(' ')[0].toUpperCase()}</span></td>`;
                    }
                    html += `</tr>`;

                    htmlIng += `<tr><td class="col-hora">${r[7]||''}</td>`;
                    for(let col=8; col<=13; col++) {
                        let v = buscarEx(dia, r[7], col, r[col]);
                        htmlIng += `<td class="slot student-cell" title="${v.toUpperCase()}" onclick="abrirEditor(this, '${dia}', '${r[7]}', ${col}, '${v}')"><span class="name-tag">${v.split(' ')[0].toUpperCase()}</span></td>`;
                    }
                    htmlIng += `</tr>`;
                }
                html += `</tbody></table></div><div class="table-block"><table><thead><tr><th class="col-hora">H</th><th colspan="6">INGL√âS</th></tr></thead><tbody>${htmlIng}</tbody></table></div></div></div>`;
                container.innerHTML += html;
            }
            cambiarDia(dias[new Date().getDay()-1] || "Lunes");
        } catch(e) { console.error(e); }
    }

    function buscarEx(dia, hora, col, original) {
        const cambio = excepcionesHoy.find(ex => ex[1] === dia && ex[2] === hora && parseInt(ex[3]) === col);
        return cambio ? cambio[4] : (original || "");
    }

    function abrirEditor(el, dia, hora, col, actual) {
        celdaActiva = { dia, hora, col };
        const rect = el.getBoundingClientRect();
        const ed = document.getElementById('quick-editor');
        document.getElementById('ed-label').innerText = `${dia} - ${hora}`;
        document.getElementById('ed-val').value = actual;
        ed.style.display = 'block';
        ed.style.top = (rect.top + window.scrollY - 10) + 'px';
        ed.style.left = (rect.left + 20) + 'px';
    }

    function cerrarEditor() { document.getElementById('quick-editor').style.display = 'none'; }

    function aplicarExcepcion() {
        const val = document.getElementById('ed-val').value;
        const dur = document.getElementById('ed-dur').value;
        const fecha = new Date().toISOString().split('T')[0];
        cerrarEditor();
        const url = `${APP_SCRIPT_URL}?v=action&fecha=${fecha}&pestana=${celdaActiva.dia}&hora=${celdaActiva.hora}&col=${celdaActiva.col}&val=${val}&dur=${dur}`;
        fetch(url, { mode: 'no-cors' }).then(() => { setTimeout(() => location.reload(), 500); });
    }

    function cambiarDia(dia) {
        document.querySelectorAll('.planning-container').forEach(v => v.classList.remove('visible'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        const target = document.getElementById(`view-${dia}`);
        if(target) {
            target.classList.add('visible');
            document.getElementById(`btn-${dia}`).classList.add('active');
        }
    }

    setInterval(() => { document.getElementById('digital-clock').innerText = new Date().toLocaleTimeString('es-ES'); }, 1000);
    window.onload = cargarTodo;
</script>
</body>
</html>
