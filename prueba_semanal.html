<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Horario Inteligente CSE</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        /* (Tus estilos se mantienen igual que en la versión anterior) */
        :root { --c-primary: #243c7a; --bg-body: #f4f6f9; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-body); margin: 0; padding: 15px; }
        .container { width: 95%; max-width: 1600px; margin: 0 auto; background: white; padding: 20px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 4px solid #ff9800; }
        .test-badge { background: #ff9800; color: white; text-align: center; font-weight: bold; padding: 5px; border-radius: 5px; margin-bottom: 15px; text-transform: uppercase; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .btn-admin { background: #333; color: #ffeb3b; padding: 10px 20px; border-radius: 50px; cursor: pointer; border: none; font-weight: bold; }
        .digital-clock { font-size: 24px; font-weight: 800; color: var(--c-primary); }
        .tables-wrapper { display: flex; gap: 20px; }
        .table-block { flex: 1; border: 1px solid #eee; border-radius: 10px; overflow: hidden; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th, td { border: 1px solid #eee; padding: 8px; text-align: center; font-size: 13px; height: 42px; }
        th { background: var(--c-primary); color: white; }
        .name-tag { font-weight: bold; color: var(--c-primary); background: #f0f4f8; padding: 4px 8px; border-radius: 6px; display: inline-block; }
        .name-tag:empty { display: none !important; }
        .days-nav { display: flex; gap: 5px; margin-bottom: 20px; justify-content: center; }
        .nav-btn { padding: 10px 20px; border: 1px solid #ddd; background: white; border-radius: 10px; cursor: pointer; font-weight: 600; }
        .nav-btn.active { background: var(--c-primary); color: white; }
        #admin-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9999; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .admin-content { background: white; width: 400px; height: 600px; border-radius: 15px; overflow: hidden; display: flex; flex-direction: column; }
    </style>
</head>
<body>
<div class="container">
    <div class="test-badge">HORARIO FIJO CON CAPA DE CAMBIOS (MODO PRUEBA)</div>
    <header>
        <button class="btn-admin" onclick="toggleAdmin()">⚙️ GESTIONAR CAMBIOS HOY</button>
        <div id="clock" class="digital-clock">00:00:00</div>
    </header>
    <div class="days-nav" id="days-buttons"></div>
    <div id="schedule-container"></div>
</div>

<div id="admin-modal">
    <div class="admin-content">
        <div style="background:#333; padding:10px; color:white; display:flex; justify-content:space-between;">
            <span style="font-weight:bold;">Editor Historial</span>
            <button onclick="toggleAdmin()" style="background:none; border:none; color:white; cursor:pointer;">✖</button>
        </div>
        <iframe id="admin-frame" style="width:100%; height:100%; border:none;"></iframe>
    </div>
</div>

<script>
    const APP_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwRRCZZZ7qfSApcoRxdVCH7pRrxYwi43pD8dv34TX8Edd22ZRZXkNIPZ-ytDEQreH8SOw/exec"; 
    const SHEET_ID = "1qx15eShPJdHaQt722I3sEUwWhL-0mcO56OMGVjm68bM"; 
    
    // GIDS MAESTROS
    const GIDS = { "Lunes": "0", "Martes": "1905233272", "Miércoles": "745373517", "Jueves": "314818236", "Viernes": "1396865785" };
    
    // !!! PON AQUÍ EL GID DE LA PESTAÑA HISTORIAL !!!
    const GID_HISTORIAL = "2008155671"; 

    let excepcionesHoy = [];

    function toggleAdmin() {
        const modal = document.getElementById('admin-modal');
        if (modal.style.display === 'flex') {
            modal.style.display = 'none';
            location.reload();
        } else {
            document.getElementById('admin-frame').src = APP_SCRIPT_URL + "?v=admin";
            modal.style.display = 'flex';
        }
    }

    async function cargarTodo() {
        const hoyFecha = new Date().toLocaleDateString('es-ES', {day:'2-digit', month:'2-digit', year:'numeric'});
        
        // 1. Leer el Historial de cambios
        const resH = await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID_HISTORIAL}&t=${Date.now()}`);
        const csvH = await resH.text();
        const dataH = Papa.parse(csvH).data;
        
        // Filtrar cambios que sean para hoy
        excepcionesHoy = dataH.filter(fila => fila[0] === hoyFecha);

        // 2. Cargar los horarios maestros
        const dias = Object.keys(GIDS);
        document.getElementById('days-buttons').innerHTML = dias.map(d => `<button class="nav-btn" id="btn-${d}" onclick="cambiarDia('${d}')">${d}</button>`).join('');

        for (const dia of dias) {
            const res = await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GIDS[dia]}&t=${Date.now()}`);
            const csv = await res.text();
            const dataMaster = Papa.parse(csv).data;

            let html = `<div id="view-${dia}" class="planning-container" style="display:none">
                <div class="tables-wrapper">
                    <div class="table-block"><table><thead><tr><th>H</th><th colspan="6">APOYO</th></tr></thead><tbody>`;
            
            let htmlIng = "";
            for (let i = 1; i < dataMaster.length; i++) {
                const r = dataMaster[i]; if(!r[0]) continue;
                
                // Procesar Fila Apoyo
                let celdasApoyo = [1,2,3,4,5,6].map(col => {
                    let valor = buscarExcepcion(dia, r[0], col, r[col]);
                    return `<td><span class="name-tag">${valor.toUpperCase()}</span></td>`;
                }).join('');

                // Procesar Fila Inglés
                let celdasIng = [8,9,10,11,12,13].map(col => {
                    let valor = buscarExcepcion(dia, r[7], col, r[col]);
                    return `<td><span class="name-tag">${valor.toUpperCase()}</span></td>`;
                }).join('');

                html += `<tr><td>${r[0]}</td>${celdasApoyo}</tr>`;
                htmlIng += `<tr><td>${r[7]||''}</td>${celdasIng}</tr>`;
            }
            html += `</tbody></table></div><div class="table-block"><table><thead><tr><th>H</th><th colspan="6">INGLÉS</th></tr></thead><tbody>${htmlIng}</tbody></table></div></div></div>`;
            document.getElementById('schedule-container').innerHTML += html;
        }
        cambiarDia(dias[new Date().getDay()-1] || "Lunes");
    }

    // FUNCIÓN CLAVE: Busca si hay un "post-it" en el historial para esta celda
    function buscarExcepcion(dia, hora, col, valorOriginal) {
        // excepcionesHoy columnas: 0:FECHA, 1:PESTAÑA, 2:HORA, 3:COLUMNA, 4:VALOR
        const cambio = excepcionesHoy.find(ex => ex[1] === dia && ex[2] === hora && parseInt(ex[3]) === col);
        
        if (cambio) {
            return cambio[4]; // Si hay cambio, devolvemos el nuevo valor (puede ser vacío)
        }
        return valorOriginal; // Si no hay cambio, devolvemos el fijo
    }

    function cambiarDia(dia) {
        document.querySelectorAll('.planning-container').forEach(v => v.style.display = 'none');
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`view-${dia}`).style.display = 'block';
        document.getElementById(`btn-${dia}`).classList.add('active');
    }

    setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString(); }, 1000);
    window.onload = cargarTodo;
</script>
</body>
</html>
